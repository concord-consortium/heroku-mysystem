MySystem=SC.Application.create({NAMESPACE:"MySystem",VERSION:"0.1.0",canvasView:null,NOVICE_STUDENT:"novice",ADVANCED_STUDENT:"advanced",DEVELOPMENT_HEAD:"head",learnerDataVersion:5,updateFromDOM:function(){SC.run(function(){var b=SC.$("#my_system_state").text(),a;if(b.trim().length===0){return}a=MySystem.migrations.migrateLearnerData(JSON.parse(b));MySystem.loadLearnerData(a)})},loadLearnerData:function(a){MySystem.store.setStudentStateDataHash(a)},isLearnerDataVersionAReleaseVersion:function(){return MySystem.migrations.isValidReleaseVersion(MySystem.learnerDataVersion)}});SC.Binding.firstIfType=function(a){return this.transform(function(b,d){var c;if(b&&(c=b.firstObject())&&c.kindOf(a)){return c}else{return null}})};SC.Record.reopen({unknownProperty:function(a,b){if(a.length>0){throw new ReferenceError("Attempt to access undeclared field '%@' of record: %@".fmt(a,this.toString()))}}});if(typeof CHANCE_SLICES==="undefined"){var CHANCE_SLICES=[]}CHANCE_SLICES=CHANCE_SLICES.concat([]);MySystem.activityController=SC.ObjectController.create({lastFeedback:"",numOfSubmits:0,canSubmit:YES,submissionInfo:function(b){var c=this.get("maxSubmissionClicks");var e=0;var d=this.get("lastFeedback");var a="";if(c&&c>0){e=this.get("numOfSubmits");a="# of submissions: %@/%@".fmt(e,c)}return a}.property("lastFeedback","maxSubmissionClicks","numOfSubmits"),getDiagramFeedback:function(b){var d;var a;MySystem.rulesController.runDiagramRules();d=MySystem.rulesController.get("success");a=MySystem.rulesController.get("feedback");MySystem.RuleFeedback.saveFeedback(MySystem.store,a,d,b.isSubmit);var c=MySystem.store.find(MySystem.RuleFeedback,MySystem.RuleFeedback.LAST_FEEDBACK_GUID);this.set("lastFeedback",c.get("feedback"));this.set("numOfSubmits",c.get("numOfSubmits"));return[d,a]},feedbackPalette:null,showFeedbackPalette:function(){var a=this.get("feedbackPalette");if(!!!a){a=MySystem.SubmissionsFeedbackPallet.create({});this.set("feedbackPalette",a)}a.append()},hideFeedbackPalette:function(){var a=this.get("feedbackPalette");if(a){a.remove()}this.enableFeedbackButton()},disableFeedbackButton:function(){this.set("canSubmit",NO)},enableFeedbackButton:function(){var a=this;setTimeout(function(){a.set("canSubmit",YES)},1000)},checkButtonPressed:function(){var f=MySystem.store.find(MySystem.RuleFeedback,MySystem.RuleFeedback.LAST_FEEDBACK_GUID);var h=null;var e=this.get("maxSubmissionClicks");var d=this.get("maxSubmissionFeedback");var j=SC.AlertPane.warn;var b=null;var c=this;var g=this.remainingFeedback();var a="submission";this.disableFeedbackButton();if(g<1){j.call(SC.AlertPane,{description:d,delegate:{alertPaneDidDismiss:function(l,k){c.enableFeedbackButton()}}});MySystem.savingController.save()}else{if(g<4){if(g>1){a=a+"s"}SC.AlertPane.warn({message:"You only have "+g+" "+a+" left",description:"Click cancel to continue working without feedback. Click OK to use a submission.",buttons:[{title:"OK"},{title:"cancel"}],delegate:{alertPaneDidDismiss:function(l,k){switch(k){case SC.BUTTON1_STATUS:c.doGetDiagramFeedback();break;case SC.BUTTON2_STATUS:c.enableFeedbackButton();break}}}})}else{this.doGetDiagramFeedback()}}},remainingFeedback:function(){var b=null;var c=this.get("maxSubmissionClicks");var a=null;if(c===0){return Infinity}b=MySystem.store.find(MySystem.RuleFeedback,MySystem.RuleFeedback.LAST_FEEDBACK_GUID);if(!b){return c}return c-b.get("numOfSubmits")},doGetDiagramFeedback:function(){results=this.getDiagramFeedback({isSubmit:YES});MySystem.savingController.submit();hasProblems=results[0];this.showFeedbackPalette()}});MySystem.nodePaletteController=SC.ArrayController.create({contentBinding:"MySystem.activityController.paletteItems",itemHeightBinding:SC.Binding.oneWay("MySystem.activityController.*content.nodeHeight"),itemHeightDidChange:function(){var a=this.get("itemHeight");this.set("rowHeight",a+15)}.observes("itemHeight")});MySystem.nodesController=SC.ArrayController.create(SC.CollectionViewDelegate,{dragLinkSrcTerminal:null,dragLinkEndTerminal:null,onlySelectedObject:function(){var a=this.get("selection");return a&&a.get("length")===1?a.firstObject():null}.property("selection"),unselectAll:function(){this.deselectObjects(this.get("selection"))},collectionViewDeleteContent:function(a,b,c){var d=c.map(function(e){return this.objectAt(e)},this);d.invoke("destroy")},collectionViewSelectionForProposedSelection:function(a,b){if(a.get("mouseDownInfo")&&a.get("mouseDownInfo").event.shiftKey){return null}else{return b}},propertyEditing:function(){MySystem.statechart.sendEvent("diagramSelectionChanged",{})}.observes("selection"),objectIsInspectable:function(b){var a=b.instanceOf(MySystem.Link)||b.instanceOf(MySystem.Node);return a},selectionIsInspectable:function(){var b=MySystem.nodesController.get("selection");var a=null;if(b.get("length")!==1){return NO}a=b.firstObject();if(!this.objectIsInspectable(a)){return NO}if(a instanceof MySystem.Link&&MySystem.activityController.get("energyTypes").length()<2&&!MySystem.activityController.get("enableLinkLabelEditing")&&!MySystem.activityController.get("enableLinkDescriptionEditing")){return NO}if(a instanceof MySystem.Node&&!MySystem.activityController.get("enableNodeDescriptionEditing")){return NO}return YES}.property("selection"),deleteObject:function(a){if(this.contains(a)){a.destroy()}},deleteSelectedObjects:function(){var a=this.get("selection").toArray();a.invoke("destroy")},focusMainPane:function(){if(MySystem.mainPage.get("mainPane")&&MySystem.mainPage.get("mainPane").get("layer")){MySystem.mainPage.getPath("mainPane").get("layer").focus();MySystem.mainPage.getPath("mainPane").get("layer").blur()}}.observes("selection")});MySystem.rubricController=SC.ObjectController.create({categoriesBinding:SC.Binding.oneWay("MySystem.activityController.rubricCategories"),score:function(submit){var self=this,rubricScore=MySystem.RubricScore.instance(),expression=MySystem.activityController.get("rubricExpression")||"",categories=MySystem.activityController.get("rubricCategories"),nodes=MySystem.nodesController.get("content"),rules=MySystem.activityController.get("diagramRules"),result=MySystem.rubricController.UNSCORED,ruleResults=[],resultsOfCategories=categories.forEach(function(c){var name=c.get("name"),value=false,found=null,rulesInCategory=rules.filterProperty("category",name);found=rulesInCategory.find(function(r){if(r.check(nodes,MySystem.rulesController)===true){return true}});if(found){value=true}ruleResults.push({name:name,value:value})}),category=function(categoryName){var category=ruleResults.findProperty("name",categoryName);if(category){return category.value}return false},hasScored=false,score=function(_score){if(!hasScored){hasScored=true;result=_score}},categoryReduce=function(args,comparefunc){var results=args.reduce(function(previousValue,current){var a=previousValue,b=current;if(typeof a==="string"){a=category(a)}if(typeof b==="string"){b=category(b)}if(typeof b==="function"){if(a===true){b.apply(this);return a}}if(typeof b==="number"){if(a===true){score(b);return a}}return(!!comparefunc(a,b))});return results},any=function(){var args=[].slice.apply(arguments);categoryReduce(args,function(a,b){return(a||b)})},all=function(){var args=[].slice.apply(arguments);categoryReduce(args,function(a,b){return(a&&b)})},errorMsg="Rubric Evaluation Error: \n%@";(function(){try{eval(expression)}catch(e){errorMsg=errorMsg.fmt(e);if(console&&typeof console.log=="function"){console.log(errorMsg)}alert(errorMsg)}}).call(self);rubricScore.update(result,ruleResults.filterProperty("value").mapProperty("name"))},displayScore:function(){MySystem.rubricController.score();rubricScore=MySystem.RubricScore.instance();alert("score: %@\ncategories: %@\nTime: %@".fmt(rubricScore.get("score"),rubricScore.get("categories"),rubricScore.get("timeStamp")))}});MySystem.rubricController.UNSCORED=-1;MySystem.rulesController=SC.ObjectController.create({success:false,feedback:"(empty feedback)",suggestions:[],nodes:[],addSuggestion:function(a){this.suggestions.push(a)},addRuleSuggestion:function(a){var b=this.find(a);this.addSuggestion(b.get("suggestion"))},checkMinimumFeedback:function(){var b=0,a=this.nodes;minimumRequirements=MySystem.activityController.get("minimumRequirements"),minimumRequirementsFB=MySystem.activityController.get("minimumRequirementsFeedback");minimumRequirements.forEach(function(c){if(!c.check(a)){b++}});if(b>0){this.addSuggestion(minimumRequirementsFB);return false}return true},rules:function(){var a=MySystem.activityController.get("diagramRules");return a},find:function(b){var e=this.rules().toArray(),d=null,c=null,a=0;if(typeof b=="object"){c=b}if(typeof b=="number"){c=e[b]}if(typeof b=="string"){for(a=0;a<e.length;a++){d=e[a];if(d.get("name")==b){c=d}}}if(null===c){this.addSuggestion("can't find rule named "+b)}return c},check:function(c){var d=this.find(c);var a=this.nodes;var b=this;return d.check(a,b)},run:function(b){var c=this.find(b);var a=this;if(!this.check(c,a)){this.addSuggestion(c.get("suggestion"))}},runAll:function(){var b=this.rules(),a=this;b.forEach(function(c){a.run(c)})},runDiagramRules:function(){var g=this.rules(),e=MySystem.activityController.get("enableCustomRuleEvaluator"),d=MySystem.activityController.get("correctFeedback"),f=this.get("success"),b=this.get("feedback");var a=this.suggestions=[];var c=this.nodes=MySystem.store.find(MySystem.Node);if(this.checkMinimumFeedback()){if(e){this._evaluateCustomRules()}else{this.runAll()}}this.suggestions=a;this._trimFeedback();f=(this.suggestions.get("length")===0);b=f?d:this.suggestions.join(" \n");this.set("success",f);this.set("feedback",b)},_trimFeedback:function(){var a=MySystem.activityController.get("maxFeedbackItems");if(a&&a>0&&this.suggestions.length>a){this.suggestions=this.suggestions.slice(0,a)}},_evaluateCustomRules:function(){(function(){var customRuleEvaluator=MySystem.activityController.get("customRuleEvaluator");var nodes=MySystem.store.find(MySystem.Node);var correctFeedback=MySystem.activityController.get("correctFeedback");var suggestions=this.suggestions;var rules=this.rules();var Rules=this;try{eval(customRuleEvaluator)}catch(e){if(console&&typeof console.log=="function"){console.log("Error evaluating custom rule: "+e)}suggestions.pushObject("Rule Evaluation Error: "+e)}}).call(this)},hasTransformation:function(){var b=this.nodes;var c=function(f,e){var d=f.get(e);return d.map(function(g){return g.get("energyType")||"unidenitfied_type"})};var a=function(e){var g=c(e,"inLinks").toArray();var f=c(e,"outLinks").toArray();if(g.length<1){return false}if(f.length<1){return false}for(var d=f.length-1;d>=0;d--){if(g.indexOf(f[d])<0){return true}}return false};return(b.filter(a).length>1)},iconsUsedOnce:function(){var b=this.nodes.toArray();var c={};var e=false;for(i=0;i<b.length;i++){var d=b[i];var a=d.get("nodeType");if(typeof c[a]==="undefined"){c[a]=0}else{c[a]=c[a]+1;e=true}}return(!e)},extraLinks:function(c){var b=MySystem.store.find(MySystem.Link);var a=null;var d=MySystem.activityController.get("diagramRules");if(c!==null&&typeof c!=="undefined"&&c.length>0){d=d.filter(function(e){return(c.indexOf(e.get("name"))>-1)})}b=b.filter(function(e){return e.isComplete()});a=b.find(function(f){var e=d.filterProperty("hasLink").filter(function(h){return !h.get("not")});var g=e.find(function(j){var k=j.paletteItem(j.get("type")),h=j.paletteItem(j.get("otherNodeType"));switch(j.get("linkDirection")){case"-->":return j.checkLink(f,k,h);case"<--":return j.checkLink(f,h,k);case"---":return j.checkLink(f,k,h)||j.checkLink(f,h,k);default:throw"Invalid linkDirection value for diagram rule."}});if(!g){return YES}});return(a!==null&&a!=="undefined")},hasNode:function(b){var a=MySystem.store.find(MySystem.Node);return(a.findProperty("nodeType",b))}});MySystem.savingController=SC.Object.create({saveFunction:null,saveTime:null,displayTime:null,saveTimer:null,autoSaveFrequency:20000,displayFrequency:5000,saveStatusText:function(){var b=this.get("saveTime"),e=0,d=0,a=0,c=new Date().getTime();if(!!!this.get("saveFunction")){return"Saving disabled."}if(!!!b){return"Not saved yet."}if(!this.get("dataIsDirty")){this.set("saveTime",new Date().getTime());return"Saved."}e=(c-b)/1000;d=e/60;a=d/60;e=Math.floor(e);d=Math.floor(d);a=Math.floor(a);if(e<60){return("Saved seconds ago.")}if(d===1){return("Saved "+d+" minute ago.")}if(d<60){return("Saved "+d+" minutes ago.")}if(a===1){return("Saved "+a+" hour ago.")}return("Saved "+a+" hours ago.")}.property("saveTime","displayTime"),enableManualSave:function(){return !!this.get("saveFunction")&&!!this.get("dataIsDirty")}.property("saveFunction","dataIsDirty"),processLearnerDiagram:function(a){MySystem.rubricController.score(a);MySystem.GraphicPreview.makePreview(MySystem.store)},save:function(){var a=NO;if(this.get("saveFunction")&&this.get("dataIsDirty")){this.processLearnerDiagram(a);this.get("saveFunction")(a)}},submit:function(){var a=YES;this.processLearnerDiagram(true);if(this.get("saveFunction")){this.get("saveFunction")(a)}},saveSuccessful:function(a){if(a){this.set("dataIsDirty",NO);this.set("saveTime",new Date().getTime())}},updateDisplayTime:function(){this.set("displayTime",new Date().getTime())},setupTimers:function(){var a=null,b=null;if(!!this.get("displayTimer")){this.get("displayTimer").invalidate();this.set("displayTimer",null)}if(!!this.get("saveTimer")){this.get("saveTimer").invalidate();this.set("saveTimer",null)}if(this.get("displayFrequency")>0){this.set("displayTimer",SC.Timer.schedule({target:this,action:"updateDisplayTime",interval:this.get("displayFrequency"),repeats:YES}))}if(this.get("autoSaveFrequency")>0){this.set("saveTimer",SC.Timer.schedule({target:this,action:"save",interval:this.get("autoSaveFrequency"),repeats:YES}))}}.observes("displayFrequency","autoSaveFrequency"),init:function(){arguments.callee.base.apply(this,arguments);this.setupTimers()},destroy:function(){this.get("saveTimer").invalidate();this.set("saveTimer",null);this.get("displayTimer").invalidate();this.set("displayTimer",null);arguments.callee.base.apply(this,arguments)}});MySystem.storyController=SC.ObjectController.create({contentBinding:"MySystem.activityController.assignmentText",instructionPanelWidth:600,instructionPanelHeight:400,instructionPalette:null,showInstructions:function(){var a=this.get("instructionPalette");if(!!!a){a=MySystem.InstructionPallet.create({});this.set("instructionPalette",a)}a.append()},hideInstructions:function(){var a=this.get("instructionPalette");if(a){a.remove()}}});MySystem.storySentenceController=SC.ArrayController.create(SC.CollectionViewDelegate,{allowsMultipleSelection:NO,editingSentence:null,collectionViewDeleteContent:function(a,e,d){var c=d.map(function(f){return this.objectAt(f)},this);c.invoke("destroy");var b=d.get("min")-1;if(b<0){b=0}this.selectObject(this.objectAt(b));return YES},collectionViewPerformDragOperation:function(b,d,f,c,a){var e=d.get("source").get("selection").firstObject();e.set("order",c);this.incrementOrderValues(c);return SC.DRAG_REORDER},addStorySentence:function(){var a;a=this.addStorySentenceNoEdit();this.selectObject(a);this.invokeLater(function(){var d=this.indexOf(a);var c=MySystem.mainPage.getPath("mainPane.topView.bottomRightView.topLeftView.bottomRightView.sentencesView.contentView");var b=c.itemViewForContentIndex(d);b.get("sentenceText").beginEditing()});return a},addStorySentenceNoEdit:function(){var a;this._incrementOrderValues(0);a=MySystem.store.createRecord(MySystem.StorySentence,{guid:MySystem.StorySentence.newGuid(),order:0,bodyText:"Describe a new step in the story."});return a},createSentence:function(a){var b=this.addStorySentence();this.addLinksAndNodesToSentence([a],b);this.addLinksAndNodesToSentence(a.get("links").map(function(c){return c.model}),b)},_incrementOrderValues:function(a){this.content.forEach(function(d,c,b){if(d.get("order")>=a){d.set("order",d.get("order")+1)}})}});MySystem.terminalController=SC.ObjectController.create({srcTerminal:null,dstTerminal:null,setDest:function(a){this.set("dstTerminal",a);MySystem.nodesController.set("dragLinkEndTerminal",a)},setSrc:function(a){this.set("srcTerminal",a);MySystem.nodesController.set("dragLinkSrcTerminal",a);this.setDest(null)},focusOut:function(a){if(a!==this.get("srcTerminal")){a.set("isHovering",NO);this.set("dstTerminal",null)}},focusIn:function(a){a.set("isHovering",YES);if(this.isDragging()){if(a!==this.get("srcTerminal")){this.setDest(a)}}},dragStart:function(a){this.setSrc(a)},dragComplete:function(){var b=this.get("srcTerminal");var a=this.get("dstTerminal");if(!!a){MySystem.statechart.sendAction("rubberbandLinkComplete")}else{MySystem.statechart.sendAction("rubberbandLinkAbandoned")}if(!!b){b.set("isLineDrag",NO);b.set("isHovering",NO);this.setSrc(null)}},isDragging:function(){return(this.get("srcTerminal")!==null)}.property("srcTerminal")});MySystem.AutoGuidRecord=SC.Record.extend();MySystem.AutoGuidRecord.mixin({updateNextId:function(d){if(!this._nextIdIndex){this._nextIdIndex=1}var c=new RegExp(this.toString()+"-(\\d+)");var a=c.exec(d);if(a!==null&&a.length>1){var b=parseInt(a[1],10);if(b>=this._nextIdIndex){this._nextIdIndex=b+1}}},_formatNumberLength:function(a,c){var b=""+a;while(b.length<c){b="0"+b}return b},getNextId:function(){var a=this._nextIdIndex;if(!a){a=1}this._nextIdIndex=a+1;return this.toString()+"-"+this._formatNumberLength(a,4)},extend:function(b){var a=SC.Record.extend.apply(this,arguments);a.reopen({guid:SC.Record.attr(String,{defaultValue:function(){return a.getNextId()}})});return a}});MySystem.MergedHashDataSource=SC.DataSource.extend({handledRecordTypes:[],ignoreUndeclaredFields:NO,keysToIgnore:["version"],dataHash:function(){return this._dataHash}.property(),init:function(){arguments.callee.base.apply(this,arguments);var g=this.get("handledRecordTypes"),f=this.get("ignoreUndeclaredFields"),e={},d={},h,b,c,a;for(c=0,a=g.get("length");c<a;c++){h=g.objectAt(c);b=h.toString();e[b]={};if(!f){d[b]=this.declaredFieldsOf(h)}}this._dataHash=e;this._declaredFields=d;this.notifyPropertyChange("dataHash")},handlesType:function(a){return this.get("handledRecordTypes").indexOf(a)>=0},dataStoreDidUpdateDataHash:function(){},fetch:function(b,f){var h=f.get("recordType"),d=f.get("recordTypes"),e=this.get("dataHash"),a,g,c=[];self=this;if(d){d.forEach(function(j){if(self.handlesType(j)){throw"MergedHashDataSource does not yet support queries with multiple recordTypes"}});return NO}if(!this.handlesType(h)){return NO}a=e[h.toString()];if(a){for(g in a){if(!a.hasOwnProperty(g)){continue}c.push(SC.copy(a[g],YES))}b.loadRecords(h,c)}b.dataSourceDidFetchQuery(f);return YES},retrieveRecord:function(c,e){var f=c.recordTypeFor(e),d=this.get("dataHash"),b,a;if(!this.handlesType(f)){return NO}b=d[f.toString()];if(!b){c.dataSourceDidError(e);return YES}a=b[c.idFor(e)];if(!a){c.dataSourceDidError(e);return YES}c.dataSourceDidComplete(e,SC.copy(a,YES));return YES},createOrUpdateRecord:function(c,e){var f=c.recordTypeFor(e),d=this.get("dataHash"),a,b;if(!this.handlesType(f)){return NO}a=f.toString();d[a]=d[a]||{};b=d[a];b[c.idFor(e)]=SC.copy(c.readDataHash(e),YES);c.dataSourceDidComplete(e);this.dataStoreDidUpdateDataHash();this.notifyPropertyChange("dataHash");return YES},createRecord:function(a,b){return this.createOrUpdateRecord(a,b)},updateRecord:function(a,b){return this.createOrUpdateRecord(a,b)},destroyRecord:function(a,c){var d=a.recordTypeFor(c),b=this.get("dataHash");if(!this.handlesType(d)){return NO}delete b[d.toString()][a.idFor(c)];a.dataSourceDidDestroy(c);this.dataStoreDidUpdateDataHash();this.notifyPropertyChange("dataHash");return YES},getRecordTypeFromName:function(a){return SC.objectForPropertyPath(a)},setDataHash:function(c,a){var g=this.get("dataHash"),d={},b,f,e;for(b in g){if(!g.hasOwnProperty(b)){continue}if(this.keysToIgnore.contains(b)){continue}f=this.getRecordTypeFromName(b);for(e in g[b]){if(!g[b].hasOwnProperty(e)){continue}if(!a[b]||!a[b][e]){c.pushDestroy(f,e)}}}for(b in a){if(!a.hasOwnProperty(b)){continue}if(this.keysToIgnore.contains(b)){continue}f=this.getRecordTypeFromName(b);if(!this.handlesType(f)){continue}d[b]={};for(e in a[b]){if(!a[b].hasOwnProperty(e)){continue}if(f.updateNextId){f.updateNextId(e)}this._verifyFieldsAreDeclared(a[b][e],b,e);c.pushRetrieve(f,e,SC.copy(a[b][e],YES));d[b][e]=SC.copy(a[b][e],YES)}}this._dataHash=d;this.notifyPropertyChange("dataHash")},declaredFieldsOf:function(d){var b=[],a=d.prototype.primaryKey,c;for(c in d.prototype){if(d.prototype[c]&&d.prototype[c].isRecordAttribute){b.push(c)}}if(a&&b.indexOf(a)<0){b.push(a)}return b},_verifyFieldsAreDeclared:function(c,b,d){if(this.get("ignoreUndeclaredFields")){return}var a=this._declaredFields[b],e;for(e in c){if(c.hasOwnProperty(e)&&a.indexOf(e)<0){throw new ReferenceError("MergedHashDataSource: data hash for record '%@' of type '%@' specifies a value for the field '%@', which is not a declared RecordAttribute".fmt(d,b,e))}}}});if(!window.console){window.console={};window.console.log=function(a){};window.console.dir=function(a){}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(b){for(var a=0;a<this.length;a++){if(this[a]==b){return a}}return -1}}(function(){this.canvg=function(j,m,b){if(j==null&&m==null&&b==null){var e=document.getElementsByTagName("svg");for(var g=0;g<e.length;g++){var f=e[g];var k=document.createElement("canvas");k.width=f.clientWidth;k.height=f.clientHeight;f.parentNode.insertBefore(k,f);f.parentNode.removeChild(f);var d=document.createElement("div");d.appendChild(f);canvg(k,d.innerHTML)}return}b=b||{};if(typeof j=="string"){j=document.getElementById(j)}var h;if(j.svg==null){h=a();j.svg=h}else{h=j.svg;h.stop()}h.opts=b;var l=j.getContext("2d");if(typeof(m.documentElement)!="undefined"){h.loadXmlDoc(l,m)}else{if(m.substr(0,1)=="<"){h.loadXml(l,m)}else{h.load(l,m)}}};function a(){var b={};b.FRAMERATE=30;b.MAX_VIRTUAL_PIXELS=30000;b.init=function(c){b.Definitions={};b.Styles={};b.Animations=[];b.Images=[];b.ctx=c;b.ViewPort=new (function(){this.viewPorts=[];this.Clear=function(){this.viewPorts=[]};this.SetCurrent=function(e,d){this.viewPorts.push({width:e,height:d})};this.RemoveCurrent=function(){this.viewPorts.pop()};this.Current=function(){return this.viewPorts[this.viewPorts.length-1]};this.width=function(){return this.Current().width};this.height=function(){return this.Current().height};this.ComputeSize=function(e){if(e!=null&&typeof(e)=="number"){return e}if(e=="x"){return this.width()}if(e=="y"){return this.height()}return Math.sqrt(Math.pow(this.width(),2)+Math.pow(this.height(),2))/Math.sqrt(2)}})};b.init();b.ImagesLoaded=function(){for(var c=0;c<b.Images.length;c++){if(!b.Images[c].loaded){return false}}return true};b.trim=function(c){return c.replace(/^\s+|\s+$/g,"")};b.compressSpaces=function(c){return c.replace(/[\s\r\t\n]+/gm," ")};b.ajax=function(d){var c;if(window.XMLHttpRequest){c=new XMLHttpRequest()}else{c=new ActiveXObject("Microsoft.XMLHTTP")}if(c){c.open("GET",d,false);c.send(null);return c.responseText}return null};b.parseXml=function(c){if(window.DOMParser){var e=new DOMParser();return e.parseFromString(c,"text/xml")}else{c=c.replace(/<!DOCTYPE svg[^>]*>/,"");var d=new ActiveXObject("Microsoft.XMLDOM");d.async="false";d.loadXML(c);return d}};b.Property=function(c,e){this.name=c;this.value=e;this.hasValue=function(){return(this.value!=null&&this.value!=="")};this.numValue=function(){if(!this.hasValue()){return 0}var f=parseFloat(this.value);if((this.value+"").match(/%$/)){f=f/100}return f};this.valueOrDefault=function(f){if(this.hasValue()){return this.value}return f};this.numValueOrDefault=function(f){if(this.hasValue()){return this.numValue()}return f};var d=this;this.Color={addOpacity:function(g){var h=d.value;if(g!=null&&g!=""){var f=new RGBColor(d.value);if(f.ok){h="rgba("+f.r+", "+f.g+", "+f.b+", "+g+")"}}return new b.Property(d.name,h)}};this.Definition={getDefinition:function(){var f=d.value.replace(/^(url\()?#([^\)]+)\)?$/,"$2");return b.Definitions[f]},isUrl:function(){return d.value.indexOf("url(")==0},getFillStyle:function(g){var f=this.getDefinition();if(f!=null&&f.createGradient){return f.createGradient(b.ctx,g)}if(f!=null&&f.createPattern){return f.createPattern(b.ctx,g)}return null}};this.Length={DPI:function(f){return 96},EM:function(h){var f=12;var g=new b.Property("fontSize",b.Font.Parse(b.ctx.font).fontSize);if(g.hasValue()){f=g.Length.toPixels(h)}return f},toPixels:function(g){if(!d.hasValue()){return 0}var f=d.value+"";if(f.match(/em$/)){return d.numValue()*this.EM(g)}if(f.match(/ex$/)){return d.numValue()*this.EM(g)/2}if(f.match(/px$/)){return d.numValue()}if(f.match(/pt$/)){return d.numValue()*1.25}if(f.match(/pc$/)){return d.numValue()*15}if(f.match(/cm$/)){return d.numValue()*this.DPI(g)/2.54}if(f.match(/mm$/)){return d.numValue()*this.DPI(g)/25.4}if(f.match(/in$/)){return d.numValue()*this.DPI(g)}if(f.match(/%$/)){return d.numValue()*b.ViewPort.ComputeSize(g)}return d.numValue()}};this.Time={toMilliseconds:function(){if(!d.hasValue()){return 0}var f=d.value+"";if(f.match(/s$/)){return d.numValue()*1000}if(f.match(/ms$/)){return d.numValue()}return d.numValue()}};this.Angle={toRadians:function(){if(!d.hasValue()){return 0}var f=d.value+"";if(f.match(/deg$/)){return d.numValue()*(Math.PI/180)}if(f.match(/grad$/)){return d.numValue()*(Math.PI/200)}if(f.match(/rad$/)){return d.numValue()}return d.numValue()*(Math.PI/180)}}};b.Font=new (function(){this.Styles=["normal","italic","oblique","inherit"];this.Variants=["normal","small-caps","inherit"];this.Weights=["normal","bold","bolder","lighter","100","200","300","400","500","600","700","800","900","inherit"];this.CreateFont=function(l,h,e,k,d,g){var j=g!=null?this.Parse(g):this.CreateFont("","","","","",b.ctx.font);return{fontFamily:d||j.fontFamily,fontSize:k||j.fontSize,fontStyle:l||j.fontStyle,fontWeight:e||j.fontWeight,fontVariant:h||j.fontVariant,toString:function(){return[this.fontStyle,this.fontVariant,this.fontWeight,this.fontSize,this.fontFamily].join(" ")}}};var c=this;this.Parse=function(h){var j={};var k=b.trim(b.compressSpaces(h||"")).split(" ");var l={fontSize:false,fontStyle:false,fontWeight:false,fontVariant:false};var e="";for(var g=0;g<k.length;g++){if(!l.fontStyle&&c.Styles.indexOf(k[g])!=-1){if(k[g]!="inherit"){j.fontStyle=k[g]}l.fontStyle=true}else{if(!l.fontVariant&&c.Variants.indexOf(k[g])!=-1){if(k[g]!="inherit"){j.fontVariant=k[g]}l.fontStyle=l.fontVariant=true}else{if(!l.fontWeight&&c.Weights.indexOf(k[g])!=-1){if(k[g]!="inherit"){j.fontWeight=k[g]}l.fontStyle=l.fontVariant=l.fontWeight=true}else{if(!l.fontSize){if(k[g]!="inherit"){j.fontSize=k[g].split("/")[0]}l.fontStyle=l.fontVariant=l.fontWeight=l.fontSize=true}else{if(k[g]!="inherit"){e+=k[g]}}}}}}if(e!=""){j.fontFamily=e}return j}});b.ToNumberArray=function(e){var c=b.trim(b.compressSpaces((e||"").replace(/,/g," "))).split(" ");for(var d=0;d<c.length;d++){c[d]=parseFloat(c[d])}return c};b.Point=function(c,d){this.x=c;this.y=d;this.angleTo=function(e){return Math.atan2(e.y-this.y,e.x-this.x)};this.applyTransform=function(e){var f=this.x*e[0]+this.y*e[2]+e[4];var g=this.x*e[1]+this.y*e[3]+e[5];this.x=f;this.y=g}};b.CreatePoint=function(d){var c=b.ToNumberArray(d);return new b.Point(c[0],c[1])};b.CreatePath=function(e){var c=b.ToNumberArray(e);var f=[];for(var d=0;d<c.length;d+=2){f.push(new b.Point(c[d],c[d+1]))}return f};b.BoundingBox=function(d,f,c,e){this.x1=Number.NaN;this.y1=Number.NaN;this.x2=Number.NaN;this.y2=Number.NaN;this.x=function(){return this.x1};this.y=function(){return this.y1};this.width=function(){return this.x2-this.x1};this.height=function(){return this.y2-this.y1};this.addPoint=function(g,h){if(g!=null){if(isNaN(this.x1)||isNaN(this.x2)){this.x1=g;this.x2=g}if(g<this.x1){this.x1=g}if(g>this.x2){this.x2=g}}if(h!=null){if(isNaN(this.y1)||isNaN(this.y2)){this.y1=h;this.y2=h}if(h<this.y1){this.y1=h}if(h>this.y2){this.y2=h}}};this.addX=function(g){this.addPoint(g,null)};this.addY=function(g){this.addPoint(null,g)};this.addBoundingBox=function(g){this.addPoint(g.x1,g.y1);this.addPoint(g.x2,g.y2)};this.addQuadraticCurve=function(m,l,h,g,o,n){var k=m+2/3*(h-m);var j=l+2/3*(g-l);var q=k+1/3*(o-m);var p=j+1/3*(n-l);this.addBezierCurve(m,l,k,q,j,p,o,n)};this.addBezierCurve=function(v,u,l,j,q,o,x,w){var m=[v,u],k=[l,j],h=[q,o],g=[x,w];this.addPoint(m[0],m[1]);this.addPoint(g[0],g[1]);for(i=0;i<=1;i++){var y=function(C){return Math.pow(1-C,3)*m[i]+3*Math.pow(1-C,2)*C*k[i]+3*(1-C)*Math.pow(C,2)*h[i]+Math.pow(C,3)*g[i]};var A=6*m[i]-12*k[i]+6*h[i];var B=-3*m[i]+9*k[i]-9*h[i]+3*g[i];var z=3*k[i]-3*m[i];if(B==0){if(A==0){continue}var s=-z/A;if(0<s&&s<1){if(i==0){this.addX(y(s))}if(i==1){this.addY(y(s))}}continue}var n=Math.pow(A,2)-4*z*B;if(n<0){continue}var r=(-A+Math.sqrt(n))/(2*B);if(0<r&&r<1){if(i==0){this.addX(y(r))}if(i==1){this.addY(y(r))}}var p=(-A-Math.sqrt(n))/(2*B);if(0<p&&p<1){if(i==0){this.addX(y(p))}if(i==1){this.addY(y(p))}}}};this.isPointInBox=function(g,h){return(this.x1<=g&&g<=this.x2&&this.y1<=h&&h<=this.y2)};this.addPoint(d,f);this.addPoint(c,e)};b.Transform=function(c){var h=this;this.Type={};this.Type.translate=function(k){this.p=b.CreatePoint(k);this.apply=function(l){l.translate(this.p.x||0,this.p.y||0)};this.applyToPoint=function(l){l.applyTransform([1,0,0,1,this.p.x||0,this.p.y||0])}};this.Type.rotate=function(l){var k=b.ToNumberArray(l);this.angle=new b.Property("angle",k[0]);this.cx=k[1]||0;this.cy=k[2]||0;this.apply=function(m){m.translate(this.cx,this.cy);m.rotate(this.angle.Angle.toRadians());m.translate(-this.cx,-this.cy)};this.applyToPoint=function(n){var m=this.angle.Angle.toRadians();n.applyTransform([1,0,0,1,this.p.x||0,this.p.y||0]);n.applyTransform([Math.cos(m),Math.sin(m),-Math.sin(m),Math.cos(m),0,0]);n.applyTransform([1,0,0,1,-this.p.x||0,-this.p.y||0])}};this.Type.scale=function(k){this.p=b.CreatePoint(k);this.apply=function(l){l.scale(this.p.x||1,this.p.y||this.p.x||1)};this.applyToPoint=function(l){l.applyTransform([this.p.x||0,0,0,this.p.y||0,0,0])}};this.Type.matrix=function(k){this.m=b.ToNumberArray(k);this.apply=function(l){l.transform(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5])};this.applyToPoint=function(l){l.applyTransform(this.m)}};this.Type.SkewBase=function(k){this.base=h.Type.matrix;this.base(k);this.angle=new b.Property("angle",k)};this.Type.SkewBase.prototype=new this.Type.matrix;this.Type.skewX=function(k){this.base=h.Type.SkewBase;this.base(k);this.m=[1,0,Math.tan(this.angle.Angle.toRadians()),1,0,0]};this.Type.skewX.prototype=new this.Type.SkewBase;this.Type.skewY=function(k){this.base=h.Type.SkewBase;this.base(k);this.m=[1,Math.tan(this.angle.Angle.toRadians()),0,1,0,0]};this.Type.skewY.prototype=new this.Type.SkewBase;this.transforms=[];this.apply=function(k){for(var l=0;l<this.transforms.length;l++){this.transforms[l].apply(k)}};this.applyToPoint=function(l){for(var k=0;k<this.transforms.length;k++){this.transforms[k].applyToPoint(l)}};var j=b.trim(b.compressSpaces(c)).split(/\s(?=[a-z])/);for(var e=0;e<j.length;e++){var g=j[e].split("(")[0];var f=j[e].split("(")[1].replace(")","");var d=new this.Type[g](f);this.transforms.push(d)}};b.AspectRatio=function(s,q,d,k,r,c,g,f,p,o){q=b.compressSpaces(q);q=q.replace(/^defer\s/,"");var j=q.split(" ")[0]||"xMidYMid";var e=q.split(" ")[1]||"meet";var n=d/k;var m=r/c;var h=Math.min(n,m);var l=Math.max(n,m);if(e=="meet"){k*=h;c*=h}if(e=="slice"){k*=l;c*=l}p=new b.Property("refX",p);o=new b.Property("refY",o);if(p.hasValue()&&o.hasValue()){s.translate(-h*p.Length.toPixels("x"),-h*o.Length.toPixels("y"))}else{if(j.match(/^xMid/)&&((e=="meet"&&h==m)||(e=="slice"&&l==m))){s.translate(d/2-k/2,0)}if(j.match(/YMid$/)&&((e=="meet"&&h==n)||(e=="slice"&&l==n))){s.translate(0,r/2-c/2)}if(j.match(/^xMax/)&&((e=="meet"&&h==m)||(e=="slice"&&l==m))){s.translate(d-k,0)}if(j.match(/YMax$/)&&((e=="meet"&&h==n)||(e=="slice"&&l==n))){s.translate(0,r-c)}}if(j=="none"){s.scale(n,m)}else{if(e=="meet"){s.scale(h,h)}else{if(e=="slice"){s.scale(l,l)}}}s.translate(g==null?0:-g,f==null?0:-f)};b.Element={};b.Element.ElementBase=function(g){this.attributes={};this.styles={};this.children=[];this.attribute=function(o,p){var j=this.attributes[o];if(j!=null){return j}j=new b.Property(o,"");if(p==true){this.attributes[o]=j}return j};this.style=function(o,u){var q=this.styles[o];if(q!=null){return q}var j=this.attribute(o);if(j!=null&&j.hasValue()){return j}var r=this.parent;if(r!=null){var t=r.style(o);if(t!=null&&t.hasValue()){return t}}q=new b.Property(o,"");if(u==true){this.styles[o]=q}return q};this.render=function(o){if(this.style("display").value=="none"){return}if(this.attribute("visibility").value=="hidden"){return}o.save();this.setContext(o);if(this.attribute("mask").hasValue()){var j=this.attribute("mask").Definition.getDefinition();if(j!=null){j.apply(o,this)}}else{if(this.style("filter").hasValue()){var p=this.style("filter").Definition.getDefinition();if(p!=null){p.apply(o,this)}}else{this.renderChildren(o)}}this.clearContext(o);o.restore()};this.setContext=function(j){};this.clearContext=function(j){};this.renderChildren=function(j){for(var o=0;o<this.children.length;o++){this.children[o].render(j)}};this.addChild=function(o,j){var p=o;if(j){p=b.CreateElement(o)}p.parent=this;this.children.push(p)};if(g!=null&&g.nodeType==1){for(var l=0;l<g.childNodes.length;l++){var c=g.childNodes[l];if(c.nodeType==1){this.addChild(c,true)}}for(var l=0;l<g.attributes.length;l++){var f=g.attributes[l];this.attributes[f.nodeName]=new b.Property(f.nodeName,f.nodeValue)}var n=b.Styles[g.nodeName];if(n!=null){for(var e in n){this.styles[e]=n[e]}}if(this.attribute("class").hasValue()){var h=b.compressSpaces(this.attribute("class").value).split(" ");for(var k=0;k<h.length;k++){n=b.Styles["."+h[k]];if(n!=null){for(var e in n){this.styles[e]=n[e]}}n=b.Styles[g.nodeName+"."+h[k]];if(n!=null){for(var e in n){this.styles[e]=n[e]}}}}if(this.attribute("style").hasValue()){var n=this.attribute("style").value.split(";");for(var l=0;l<n.length;l++){if(b.trim(n[l])!=""){var d=n[l].split(":");var e=b.trim(d[0]);var m=b.trim(d[1]);this.styles[e]=new b.Property(e,m)}}}if(this.attribute("id").hasValue()){if(b.Definitions[this.attribute("id").value]==null){b.Definitions[this.attribute("id").value]=this}}}};b.Element.RenderedElementBase=function(c){this.base=b.Element.ElementBase;this.base(c);this.setContext=function(e){if(this.style("fill").Definition.isUrl()){var d=this.style("fill").Definition.getFillStyle(this);if(d!=null){e.fillStyle=d}}else{if(this.style("fill").hasValue()){var f=this.style("fill");if(this.style("fill-opacity").hasValue()){f=f.Color.addOpacity(this.style("fill-opacity").value)}e.fillStyle=(f.value=="none"?"rgba(0,0,0,0)":f.value)}}if(this.style("stroke").Definition.isUrl()){var d=this.style("stroke").Definition.getFillStyle(this);if(d!=null){e.strokeStyle=d}}else{if(this.style("stroke").hasValue()){var j=this.style("stroke");if(this.style("stroke-opacity").hasValue()){j=j.Color.addOpacity(this.style("stroke-opacity").value)}e.strokeStyle=(j.value=="none"?"rgba(0,0,0,0)":j.value)}}if(this.style("stroke-width").hasValue()){e.lineWidth=this.style("stroke-width").Length.toPixels()}if(this.style("stroke-linecap").hasValue()){e.lineCap=this.style("stroke-linecap").value}if(this.style("stroke-linejoin").hasValue()){e.lineJoin=this.style("stroke-linejoin").value}if(this.style("stroke-miterlimit").hasValue()){e.miterLimit=this.style("stroke-miterlimit").value}if(typeof(e.font)!="undefined"){e.font=b.Font.CreateFont(this.style("font-style").value,this.style("font-variant").value,this.style("font-weight").value,this.style("font-size").hasValue()?this.style("font-size").Length.toPixels()+"px":"",this.style("font-family").value).toString()}if(this.attribute("transform").hasValue()){var g=new b.Transform(this.attribute("transform").value);g.apply(e)}if(this.attribute("clip-path").hasValue()){var h=this.attribute("clip-path").Definition.getDefinition();if(h!=null){h.apply(e)}}if(this.style("opacity").hasValue()){e.globalAlpha=this.style("opacity").numValue()}}};b.Element.RenderedElementBase.prototype=new b.Element.ElementBase;b.Element.PathElementBase=function(c){this.base=b.Element.RenderedElementBase;this.base(c);this.path=function(d){if(d!=null){d.beginPath()}return new b.BoundingBox()};this.renderChildren=function(e){this.path(e);b.Mouse.checkPath(this,e);if(e.fillStyle!=""){e.fill()}if(e.strokeStyle!=""){e.stroke()}var g=this.getMarkers();if(g!=null){if(this.style("marker-start").Definition.isUrl()){var d=this.style("marker-start").Definition.getDefinition();d.render(e,g[0][0],g[0][1])}if(this.style("marker-mid").Definition.isUrl()){var d=this.style("marker-mid").Definition.getDefinition();for(var f=1;f<g.length-1;f++){d.render(e,g[f][0],g[f][1])}}if(this.style("marker-end").Definition.isUrl()){var d=this.style("marker-end").Definition.getDefinition();d.render(e,g[g.length-1][0],g[g.length-1][1])}}};this.getBoundingBox=function(){return this.path()};this.getMarkers=function(){return null}};b.Element.PathElementBase.prototype=new b.Element.RenderedElementBase;b.Element.svg=function(c){this.base=b.Element.RenderedElementBase;this.base(c);this.baseClearContext=this.clearContext;this.clearContext=function(d){this.baseClearContext(d);b.ViewPort.RemoveCurrent()};this.baseSetContext=this.setContext;this.setContext=function(g){g.strokeStyle="rgba(0,0,0,0)";g.lineCap="butt";g.lineJoin="miter";g.miterLimit=4;this.baseSetContext(g);if(this.attribute("x").hasValue()&&this.attribute("y").hasValue()){g.translate(this.attribute("x").Length.toPixels("x"),this.attribute("y").Length.toPixels("y"))}var h=b.ViewPort.width();var f=b.ViewPort.height();if(typeof(this.root)=="undefined"&&this.attribute("width").hasValue()&&this.attribute("height").hasValue()){h=this.attribute("width").Length.toPixels("x");f=this.attribute("height").Length.toPixels("y");var e=0;var l=0;if(this.attribute("refX").hasValue()&&this.attribute("refY").hasValue()){e=-this.attribute("refX").Length.toPixels("x");l=-this.attribute("refY").Length.toPixels("y")}g.beginPath();g.moveTo(e,l);g.lineTo(h,l);g.lineTo(h,f);g.lineTo(e,f);g.closePath();g.clip()}b.ViewPort.SetCurrent(h,f);if(this.attribute("viewBox").hasValue()){var j=b.ToNumberArray(this.attribute("viewBox").value);var d=j[0];var k=j[1];h=j[2];f=j[3];b.AspectRatio(g,this.attribute("preserveAspectRatio").value,b.ViewPort.width(),h,b.ViewPort.height(),f,d,k,this.attribute("refX").value,this.attribute("refY").value);b.ViewPort.RemoveCurrent();b.ViewPort.SetCurrent(j[2],j[3])}}};b.Element.svg.prototype=new b.Element.RenderedElementBase;b.Element.rect=function(c){this.base=b.Element.PathElementBase;this.base(c);this.path=function(f){var e=this.attribute("x").Length.toPixels("x");var k=this.attribute("y").Length.toPixels("y");var g=this.attribute("width").Length.toPixels("x");var d=this.attribute("height").Length.toPixels("y");var j=this.attribute("rx").Length.toPixels("x");var h=this.attribute("ry").Length.toPixels("y");if(this.attribute("rx").hasValue()&&!this.attribute("ry").hasValue()){h=j}if(this.attribute("ry").hasValue()&&!this.attribute("rx").hasValue()){j=h}if(f!=null){f.beginPath();f.moveTo(e+j,k);f.lineTo(e+g-j,k);f.quadraticCurveTo(e+g,k,e+g,k+h);f.lineTo(e+g,k+d-h);f.quadraticCurveTo(e+g,k+d,e+g-j,k+d);f.lineTo(e+j,k+d);f.quadraticCurveTo(e,k+d,e,k+d-h);f.lineTo(e,k+h);f.quadraticCurveTo(e,k,e+j,k);f.closePath()}return new b.BoundingBox(e,k,e+g,k+d)}};b.Element.rect.prototype=new b.Element.PathElementBase;b.Element.circle=function(c){this.base=b.Element.PathElementBase;this.base(c);this.path=function(e){var d=this.attribute("cx").Length.toPixels("x");var g=this.attribute("cy").Length.toPixels("y");var f=this.attribute("r").Length.toPixels();if(e!=null){e.beginPath();e.arc(d,g,f,0,Math.PI*2,true);e.closePath()}return new b.BoundingBox(d-f,g-f,d+f,g+f)}};b.Element.circle.prototype=new b.Element.PathElementBase;b.Element.ellipse=function(c){this.base=b.Element.PathElementBase;this.base(c);this.path=function(e){var g=4*((Math.sqrt(2)-1)/3);var h=this.attribute("rx").Length.toPixels("x");var f=this.attribute("ry").Length.toPixels("y");var d=this.attribute("cx").Length.toPixels("x");var j=this.attribute("cy").Length.toPixels("y");if(e!=null){e.beginPath();e.moveTo(d,j-f);e.bezierCurveTo(d+(g*h),j-f,d+h,j-(g*f),d+h,j);e.bezierCurveTo(d+h,j+(g*f),d+(g*h),j+f,d,j+f);e.bezierCurveTo(d-(g*h),j+f,d-h,j+(g*f),d-h,j);e.bezierCurveTo(d-h,j-(g*f),d-(g*h),j-f,d,j-f);e.closePath()}return new b.BoundingBox(d-h,j-f,d+h,j+f)}};b.Element.ellipse.prototype=new b.Element.PathElementBase;b.Element.line=function(c){this.base=b.Element.PathElementBase;this.base(c);this.getPoints=function(){return[new b.Point(this.attribute("x1").Length.toPixels("x"),this.attribute("y1").Length.toPixels("y")),new b.Point(this.attribute("x2").Length.toPixels("x"),this.attribute("y2").Length.toPixels("y"))]};this.path=function(d){var e=this.getPoints();if(d!=null){d.beginPath();d.moveTo(e[0].x,e[0].y);d.lineTo(e[1].x,e[1].y)}return new b.BoundingBox(e[0].x,e[0].y,e[1].x,e[1].y)};this.getMarkers=function(){var e=this.getPoints();var d=e[0].angleTo(e[1]);return[[e[0],d],[e[1],d]]}};b.Element.line.prototype=new b.Element.PathElementBase;b.Element.polyline=function(c){this.base=b.Element.PathElementBase;this.base(c);this.points=b.CreatePath(this.attribute("points").value);this.path=function(d){var f=new b.BoundingBox(this.points[0].x,this.points[0].y);if(d!=null){d.beginPath();d.moveTo(this.points[0].x,this.points[0].y)}for(var e=1;e<this.points.length;e++){f.addPoint(this.points[e].x,this.points[e].y);if(d!=null){d.lineTo(this.points[e].x,this.points[e].y)}}return f};this.getMarkers=function(){var e=[];for(var d=0;d<this.points.length-1;d++){e.push([this.points[d],this.points[d].angleTo(this.points[d+1])])}e.push([this.points[this.points.length-1],e[e.length-1][1]]);return e}};b.Element.polyline.prototype=new b.Element.PathElementBase;b.Element.polygon=function(c){this.base=b.Element.polyline;this.base(c);this.basePath=this.path;this.path=function(d){var e=this.basePath(d);if(d!=null){d.lineTo(this.points[0].x,this.points[0].y);d.closePath()}return e}};b.Element.polygon.prototype=new b.Element.polyline;b.Element.path=function(c){this.base=b.Element.PathElementBase;this.base(c);var e=this.attribute("d").value;e=e.replace(/,/gm," ");e=e.replace(/([MmZzLlHhVvCcSsQqTtAa])([MmZzLlHhVvCcSsQqTtAa])/gm,"$1 $2");e=e.replace(/([MmZzLlHhVvCcSsQqTtAa])([MmZzLlHhVvCcSsQqTtAa])/gm,"$1 $2");e=e.replace(/([MmZzLlHhVvCcSsQqTtAa])([^\s])/gm,"$1 $2");e=e.replace(/([^\s])([MmZzLlHhVvCcSsQqTtAa])/gm,"$1 $2");e=e.replace(/([0-9])([+\-])/gm,"$1 $2");e=e.replace(/(\.[0-9]*)(\.)/gm,"$1 $2");e=e.replace(/([Aa](\s+[0-9]+){3})\s+([01])\s*([01])/gm,"$1 $3 $4 ");e=b.compressSpaces(e);e=b.trim(e);this.PathParser=new (function(f){this.tokens=f.split(" ");this.reset=function(){this.i=-1;this.command="";this.previousCommand="";this.start=new b.Point(0,0);this.control=new b.Point(0,0);this.current=new b.Point(0,0);this.points=[];this.angles=[]};this.isEnd=function(){return this.i>=this.tokens.length-1};this.isCommandOrEnd=function(){if(this.isEnd()){return true}return this.tokens[this.i+1].match(/^[A-Za-z]$/)!=null};this.isRelativeCommand=function(){return this.command==this.command.toLowerCase()};this.getToken=function(){this.i=this.i+1;return this.tokens[this.i]};this.getScalar=function(){return parseFloat(this.getToken())};this.nextCommand=function(){this.previousCommand=this.command;this.command=this.getToken()};this.getPoint=function(){var d=new b.Point(this.getScalar(),this.getScalar());return this.makeAbsolute(d)};this.getAsControlPoint=function(){var d=this.getPoint();this.control=d;return d};this.getAsCurrentPoint=function(){var d=this.getPoint();this.current=d;return d};this.getReflectedControlPoint=function(){if(this.previousCommand.toLowerCase()!="c"&&this.previousCommand.toLowerCase()!="s"){return this.current}var d=new b.Point(2*this.current.x-this.control.x,2*this.current.y-this.control.y);return d};this.makeAbsolute=function(d){if(this.isRelativeCommand()){d.x=this.current.x+d.x;d.y=this.current.y+d.y}return d};this.addMarker=function(g,h,d){if(d!=null&&this.angles.length>0&&this.angles[this.angles.length-1]==null){this.angles[this.angles.length-1]=this.points[this.points.length-1].angleTo(d)}this.addMarkerAngle(g,h==null?null:h.angleTo(g))};this.addMarkerAngle=function(g,d){this.points.push(g);this.angles.push(d)};this.getMarkerPoints=function(){return this.points};this.getMarkerAngles=function(){for(var g=0;g<this.angles.length;g++){if(this.angles[g]==null){for(var d=g+1;d<this.angles.length;d++){if(this.angles[d]!=null){this.angles[g]=this.angles[d];break}}}}return this.angles}})(e);this.path=function(H){var J=this.PathParser;J.reset();var t=new b.BoundingBox();if(H!=null){H.beginPath()}while(!J.isEnd()){J.nextCommand();switch(J.command.toUpperCase()){case"M":var F=J.getAsCurrentPoint();J.addMarker(F);t.addPoint(F.x,F.y);if(H!=null){H.moveTo(F.x,F.y)}J.start=J.current;while(!J.isCommandOrEnd()){var F=J.getAsCurrentPoint();J.addMarker(F,J.start);t.addPoint(F.x,F.y);if(H!=null){H.lineTo(F.x,F.y)}}break;case"L":while(!J.isCommandOrEnd()){var M=J.current;var F=J.getAsCurrentPoint();J.addMarker(F,M);t.addPoint(F.x,F.y);if(H!=null){H.lineTo(F.x,F.y)}}break;case"H":while(!J.isCommandOrEnd()){var g=new b.Point((J.isRelativeCommand()?J.current.x:0)+J.getScalar(),J.current.y);J.addMarker(g,J.current);J.current=g;t.addPoint(J.current.x,J.current.y);if(H!=null){H.lineTo(J.current.x,J.current.y)}}break;case"V":while(!J.isCommandOrEnd()){var g=new b.Point(J.current.x,(J.isRelativeCommand()?J.current.y:0)+J.getScalar());J.addMarker(g,J.current);J.current=g;t.addPoint(J.current.x,J.current.y);if(H!=null){H.lineTo(J.current.x,J.current.y)}}break;case"C":while(!J.isCommandOrEnd()){var K=J.current;var j=J.getPoint();var k=J.getAsControlPoint();var x=J.getAsCurrentPoint();J.addMarker(x,k,j);t.addBezierCurve(K.x,K.y,j.x,j.y,k.x,k.y,x.x,x.y);if(H!=null){H.bezierCurveTo(j.x,j.y,k.x,k.y,x.x,x.y)}}break;case"S":while(!J.isCommandOrEnd()){var K=J.current;var j=J.getReflectedControlPoint();var k=J.getAsControlPoint();var x=J.getAsCurrentPoint();J.addMarker(x,k,j);t.addBezierCurve(K.x,K.y,j.x,j.y,k.x,k.y,x.x,x.y);if(H!=null){H.bezierCurveTo(j.x,j.y,k.x,k.y,x.x,x.y)}}break;case"Q":while(!J.isCommandOrEnd()){var K=J.current;var k=J.getAsControlPoint();var x=J.getAsCurrentPoint();J.addMarker(x,k,k);t.addQuadraticCurve(K.x,K.y,k.x,k.y,x.x,x.y);if(H!=null){H.quadraticCurveTo(k.x,k.y,x.x,x.y)}}break;case"T":while(!J.isCommandOrEnd()){var K=J.current;var k=J.getReflectedControlPoint();J.control=k;var x=J.getAsCurrentPoint();J.addMarker(x,k,k);t.addQuadraticCurve(K.x,K.y,k.x,k.y,x.x,x.y);if(H!=null){H.quadraticCurveTo(k.x,k.y,x.x,x.y)}}break;case"A":while(!J.isCommandOrEnd()){var K=J.current;var q=J.getScalar();var o=J.getScalar();var f=J.getScalar()*(Math.PI/180);var w=J.getScalar();var n=J.getScalar();var x=J.getAsCurrentPoint();var P=new b.Point(Math.cos(f)*(K.x-x.x)/2+Math.sin(f)*(K.y-x.y)/2,-Math.sin(f)*(K.x-x.x)/2+Math.cos(f)*(K.y-x.y)/2);var I=Math.pow(P.x,2)/Math.pow(q,2)+Math.pow(P.y,2)/Math.pow(o,2);if(I>1){q*=Math.sqrt(I);o*=Math.sqrt(I)}var B=(w==n?-1:1)*Math.sqrt(((Math.pow(q,2)*Math.pow(o,2))-(Math.pow(q,2)*Math.pow(P.y,2))-(Math.pow(o,2)*Math.pow(P.x,2)))/(Math.pow(q,2)*Math.pow(P.y,2)+Math.pow(o,2)*Math.pow(P.x,2)));if(isNaN(B)){B=0}var A=new b.Point(B*q*P.y/o,B*-o*P.x/q);var h=new b.Point((K.x+x.x)/2+Math.cos(f)*A.x-Math.sin(f)*A.y,(K.y+x.y)/2+Math.sin(f)*A.x+Math.cos(f)*A.y);var G=function(l){return Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2))};var D=function(m,l){return(m[0]*l[0]+m[1]*l[1])/(G(m)*G(l))};var N=function(m,l){return(m[0]*l[1]<m[1]*l[0]?-1:1)*Math.acos(D(m,l))};var O=N([1,0],[(P.x-A.x)/q,(P.y-A.y)/o]);var z=[(P.x-A.x)/q,(P.y-A.y)/o];var y=[(-P.x-A.x)/q,(-P.y-A.y)/o];var L=N(z,y);if(D(z,y)<=-1){L=Math.PI}if(D(z,y)>=1){L=0}if(n==0&&L>0){L=L-2*Math.PI}if(n==1&&L<0){L=L+2*Math.PI}var d=new b.Point(h.x-q*Math.cos((O+L)/2),h.y-o*Math.sin((O+L)/2));J.addMarkerAngle(d,(O+L)/2+(n==0?1:-1)*Math.PI/2);J.addMarkerAngle(x,L+(n==0?1:-1)*Math.PI/2);t.addPoint(x.x,x.y);if(H!=null){var D=q>o?q:o;var E=q>o?1:q/o;var C=q>o?o/q:1;H.translate(h.x,h.y);H.rotate(f);H.scale(E,C);H.arc(0,0,D,O,O+L,1-n);H.scale(1/E,1/C);H.rotate(-f);H.translate(-h.x,-h.y)}}break;case"Z":if(H!=null){H.closePath()}J.current=J.start}}return t};this.getMarkers=function(){var f=this.PathParser.getMarkerPoints();var h=this.PathParser.getMarkerAngles();var g=[];for(var d=0;d<f.length;d++){g.push([f[d],h[d]])}return g}};b.Element.path.prototype=new b.Element.PathElementBase;b.Element.pattern=function(c){this.base=b.Element.ElementBase;this.base(c);this.createPattern=function(d,e){var f=new b.Element.svg();f.attributes.viewBox=new b.Property("viewBox",this.attribute("viewBox").value);f.attributes.x=new b.Property("x",this.attribute("x").value);f.attributes.y=new b.Property("y",this.attribute("y").value);f.attributes.width=new b.Property("width",this.attribute("width").value);f.attributes.height=new b.Property("height",this.attribute("height").value);f.children=this.children;var g=document.createElement("canvas");g.width=this.attribute("width").Length.toPixels("x");g.height=this.attribute("height").Length.toPixels("y");f.render(g.getContext("2d"));return d.createPattern(g,"repeat")}};b.Element.pattern.prototype=new b.Element.ElementBase;b.Element.marker=function(c){this.base=b.Element.ElementBase;this.base(c);this.baseRender=this.render;this.render=function(e,d,g){e.translate(d.x,d.y);if(this.attribute("orient").valueOrDefault("auto")=="auto"){e.rotate(g)}if(this.attribute("markerUnits").valueOrDefault("strokeWidth")=="strokeWidth"){e.scale(e.lineWidth,e.lineWidth)}e.save();var f=new b.Element.svg();f.attributes.viewBox=new b.Property("viewBox",this.attribute("viewBox").value);f.attributes.refX=new b.Property("refX",this.attribute("refX").value);f.attributes.refY=new b.Property("refY",this.attribute("refY").value);f.attributes.width=new b.Property("width",this.attribute("markerWidth").value);f.attributes.height=new b.Property("height",this.attribute("markerHeight").value);f.attributes.fill=new b.Property("fill",this.attribute("fill").valueOrDefault("black"));f.attributes.stroke=new b.Property("stroke",this.attribute("stroke").valueOrDefault("none"));f.children=this.children;f.render(e);e.restore();if(this.attribute("markerUnits").valueOrDefault("strokeWidth")=="strokeWidth"){e.scale(1/e.lineWidth,1/e.lineWidth)}if(this.attribute("orient").valueOrDefault("auto")=="auto"){e.rotate(-g)}e.translate(-d.x,-d.y)}};b.Element.marker.prototype=new b.Element.ElementBase;b.Element.defs=function(c){this.base=b.Element.ElementBase;this.base(c);this.render=function(d){}};b.Element.defs.prototype=new b.Element.ElementBase;b.Element.GradientBase=function(d){this.base=b.Element.ElementBase;this.base(d);this.gradientUnits=this.attribute("gradientUnits").valueOrDefault("objectBoundingBox");this.stops=[];for(var c=0;c<this.children.length;c++){var e=this.children[c];this.stops.push(e)}this.getGradient=function(){};this.createGradient=function(r,h){var q=this;if(this.attribute("xlink:href").hasValue()){q=this.attribute("xlink:href").Definition.getDefinition()}var k=this.getGradient(r,h);for(var j=0;j<q.stops.length;j++){k.addColorStop(q.stops[j].offset,q.stops[j].color)}if(this.attribute("gradientTransform").hasValue()){var m=b.ViewPort.viewPorts[0];var n=new b.Element.rect();n.attributes.x=new b.Property("x",-b.MAX_VIRTUAL_PIXELS/3);n.attributes.y=new b.Property("y",-b.MAX_VIRTUAL_PIXELS/3);n.attributes.width=new b.Property("width",b.MAX_VIRTUAL_PIXELS);n.attributes.height=new b.Property("height",b.MAX_VIRTUAL_PIXELS);var p=new b.Element.g();p.attributes.transform=new b.Property("transform",this.attribute("gradientTransform").value);p.children=[n];var o=new b.Element.svg();o.attributes.x=new b.Property("x",0);o.attributes.y=new b.Property("y",0);o.attributes.width=new b.Property("width",m.width);o.attributes.height=new b.Property("height",m.height);o.children=[p];var l=document.createElement("canvas");l.width=m.width;l.height=m.height;var f=l.getContext("2d");f.fillStyle=k;o.render(f);return f.createPattern(l,"no-repeat")}return k}};b.Element.GradientBase.prototype=new b.Element.ElementBase;b.Element.linearGradient=function(c){this.base=b.Element.GradientBase;this.base(c);this.getGradient=function(d,h){var k=h.getBoundingBox();var f=(this.gradientUnits=="objectBoundingBox"?k.x()+k.width()*this.attribute("x1").numValue():this.attribute("x1").Length.toPixels("x"));var j=(this.gradientUnits=="objectBoundingBox"?k.y()+k.height()*this.attribute("y1").numValue():this.attribute("y1").Length.toPixels("y"));var e=(this.gradientUnits=="objectBoundingBox"?k.x()+k.width()*this.attribute("x2").numValue():this.attribute("x2").Length.toPixels("x"));var g=(this.gradientUnits=="objectBoundingBox"?k.y()+k.height()*this.attribute("y2").numValue():this.attribute("y2").Length.toPixels("y"));return d.createLinearGradient(f,j,e,g)}};b.Element.linearGradient.prototype=new b.Element.GradientBase;b.Element.radialGradient=function(c){this.base=b.Element.GradientBase;this.base(c);this.getGradient=function(e,f){var k=f.getBoundingBox();var d=(this.gradientUnits=="objectBoundingBox"?k.x()+k.width()*this.attribute("cx").numValue():this.attribute("cx").Length.toPixels("x"));var l=(this.gradientUnits=="objectBoundingBox"?k.y()+k.height()*this.attribute("cy").numValue():this.attribute("cy").Length.toPixels("y"));var j=d;var g=l;if(this.attribute("fx").hasValue()){j=(this.gradientUnits=="objectBoundingBox"?k.x()+k.width()*this.attribute("fx").numValue():this.attribute("fx").Length.toPixels("x"))}if(this.attribute("fy").hasValue()){g=(this.gradientUnits=="objectBoundingBox"?k.y()+k.height()*this.attribute("fy").numValue():this.attribute("fy").Length.toPixels("y"))}var h=(this.gradientUnits=="objectBoundingBox"?(k.width()+k.height())/2*this.attribute("r").numValue():this.attribute("r").Length.toPixels());return e.createRadialGradient(j,g,0,d,l,h)}};b.Element.radialGradient.prototype=new b.Element.GradientBase;b.Element.stop=function(d){this.base=b.Element.ElementBase;this.base(d);this.offset=this.attribute("offset").numValue();var c=this.style("stop-color");if(this.style("stop-opacity").hasValue()){c=c.Color.addOpacity(this.style("stop-opacity").value)}this.color=c.value};b.Element.stop.prototype=new b.Element.ElementBase;b.Element.AnimateBase=function(c){this.base=b.Element.ElementBase;this.base(c);b.Animations.push(this);this.duration=0;this.begin=this.attribute("begin").Time.toMilliseconds();this.maxDuration=this.begin+this.attribute("dur").Time.toMilliseconds();this.getProperty=function(){var e=this.attribute("attributeType").value;var d=this.attribute("attributeName").value;if(e=="CSS"){return this.parent.style(d,true)}return this.parent.attribute(d,true)};this.initialValue=null;this.removed=false;this.calcValue=function(){return""};this.update=function(g){if(this.initialValue==null){this.initialValue=this.getProperty().value}if(this.duration>this.maxDuration){if(this.attribute("repeatCount").value=="indefinite"){this.duration=0}else{if(this.attribute("fill").valueOrDefault("remove")=="remove"&&!this.removed){this.removed=true;this.getProperty().value=this.initialValue;return true}else{return false}}}this.duration=this.duration+g;var d=false;if(this.begin<this.duration){var f=this.calcValue();if(this.attribute("type").hasValue()){var e=this.attribute("type").value;f=e+"("+f+")"}this.getProperty().value=f;d=true}return d};this.progress=function(){return((this.duration-this.begin)/(this.maxDuration-this.begin))}};b.Element.AnimateBase.prototype=new b.Element.ElementBase;b.Element.animate=function(c){this.base=b.Element.AnimateBase;this.base(c);this.calcValue=function(){var e=this.attribute("from").numValue();var d=this.attribute("to").numValue();return e+(d-e)*this.progress()}};b.Element.animate.prototype=new b.Element.AnimateBase;b.Element.animateColor=function(c){this.base=b.Element.AnimateBase;this.base(c);this.calcValue=function(){var j=new RGBColor(this.attribute("from").value);var h=new RGBColor(this.attribute("to").value);if(j.ok&&h.ok){var f=j.r+(h.r-j.r)*this.progress();var e=j.g+(h.g-j.g)*this.progress();var d=j.b+(h.b-j.b)*this.progress();return"rgb("+parseInt(f,10)+","+parseInt(e,10)+","+parseInt(d,10)+")"}return this.attribute("from").value}};b.Element.animateColor.prototype=new b.Element.AnimateBase;b.Element.animateTransform=function(c){this.base=b.Element.animate;this.base(c)};b.Element.animateTransform.prototype=new b.Element.animate;b.Element.font=function(d){this.base=b.Element.ElementBase;this.base(d);this.horizAdvX=this.attribute("horiz-adv-x").numValue();this.isRTL=false;this.isArabic=false;this.fontFace=null;this.missingGlyph=null;this.glyphs=[];for(var c=0;c<this.children.length;c++){var e=this.children[c];if(e.type=="font-face"){this.fontFace=e;if(e.style("font-family").hasValue()){b.Definitions[e.style("font-family").value]=this}}else{if(e.type=="missing-glyph"){this.missingGlyph=e}else{if(e.type=="glyph"){if(e.arabicForm!=""){this.isRTL=true;this.isArabic=true;if(typeof(this.glyphs[e.unicode])=="undefined"){this.glyphs[e.unicode]=[]}this.glyphs[e.unicode][e.arabicForm]=e}else{this.glyphs[e.unicode]=e}}}}}};b.Element.font.prototype=new b.Element.ElementBase;b.Element.fontface=function(c){this.base=b.Element.ElementBase;this.base(c);this.ascent=this.attribute("ascent").value;this.descent=this.attribute("descent").value;this.unitsPerEm=this.attribute("units-per-em").numValue()};b.Element.fontface.prototype=new b.Element.ElementBase;b.Element.missingglyph=function(c){this.base=b.Element.path;this.base(c);this.horizAdvX=0};b.Element.missingglyph.prototype=new b.Element.path;b.Element.glyph=function(c){this.base=b.Element.path;this.base(c);this.horizAdvX=this.attribute("horiz-adv-x").numValue();this.unicode=this.attribute("unicode").value;this.arabicForm=this.attribute("arabic-form").value};b.Element.glyph.prototype=new b.Element.path;b.Element.text=function(e){this.base=b.Element.RenderedElementBase;this.base(e);if(e!=null){this.children=[];for(var d=0;d<e.childNodes.length;d++){var c=e.childNodes[d];if(c.nodeType==1){this.addChild(c,true)}else{if(c.nodeType==3){this.addChild(new b.Element.tspan(c),false)}}}}this.baseSetContext=this.setContext;this.setContext=function(f){this.baseSetContext(f);if(this.style("dominant-baseline").hasValue()){f.textBaseline=this.style("dominant-baseline").value}if(this.style("alignment-baseline").hasValue()){f.textBaseline=this.style("alignment-baseline").value}};this.renderChildren=function(q){var h=this.style("text-anchor").valueOrDefault("start");var p=this.attribute("x").Length.toPixels("x");var o=this.attribute("y").Length.toPixels("y");for(var m=0;m<this.children.length;m++){var g=this.children[m];if(g.attribute("x").hasValue()){g.x=g.attribute("x").Length.toPixels("x")}else{if(g.attribute("dx").hasValue()){p+=g.attribute("dx").Length.toPixels("x")}g.x=p}var n=g.measureText(q);if(h!="start"&&(m==0||g.attribute("x").hasValue())){var f=n;for(var l=m+1;l<this.children.length;l++){var k=this.children[l];if(k.attribute("x").hasValue()){break}f+=k.measureText(q)}g.x-=(h=="end"?f:f/2)}p=g.x+n;if(g.attribute("y").hasValue()){g.y=g.attribute("y").Length.toPixels("y")}else{if(g.attribute("dy").hasValue()){o+=g.attribute("dy").Length.toPixels("y")}g.y=o}o=g.y;g.render(q)}}};b.Element.text.prototype=new b.Element.RenderedElementBase;b.Element.TextElementBase=function(c){this.base=b.Element.RenderedElementBase;this.base(c);this.getGlyph=function(d,h,e){var j=h[e];var f=null;if(d.isArabic){var g="isolated";if((e==0||h[e-1]==" ")&&e<h.length-2&&h[e+1]!=" "){g="terminal"}if(e>0&&h[e-1]!=" "&&e<h.length-2&&h[e+1]!=" "){g="medial"}if(e>0&&h[e-1]!=" "&&(e==h.length-1||h[e+1]==" ")){g="initial"}if(typeof(d.glyphs[j])!="undefined"){f=d.glyphs[j][g];if(f==null&&d.glyphs[j].type=="glyph"){f=d.glyphs[j]}}}else{f=d.glyphs[j]}if(f==null){f=d.missingGlyph}return f};this.renderChildren=function(l){var j=this.parent.style("font-family").Definition.getDefinition();if(j!=null){var m=this.parent.style("font-size").numValueOrDefault(b.Font.Parse(b.ctx.font).fontSize);var f=this.parent.style("font-style").valueOrDefault(b.Font.Parse(b.ctx.font).fontStyle);var k=this.getText();if(j.isRTL){k=k.split("").reverse().join("")}var n=b.ToNumberArray(this.parent.attribute("dx").value);for(var g=0;g<k.length;g++){var h=this.getGlyph(j,k,g);var e=m/j.fontFace.unitsPerEm;l.translate(this.x,this.y);l.scale(e,-e);var d=l.lineWidth;l.lineWidth=l.lineWidth*j.fontFace.unitsPerEm/m;if(f=="italic"){l.transform(1,0,0.4,1,0,0)}h.render(l);if(f=="italic"){l.transform(1,0,-0.4,1,0,0)}l.lineWidth=d;l.scale(1/e,-1/e);l.translate(-this.x,-this.y);this.x+=m*(h.horizAdvX||j.horizAdvX)/j.fontFace.unitsPerEm;if(typeof(n[g])!="undefined"&&!isNaN(n[g])){this.x+=n[g]}}return}if(l.strokeStyle!=""){l.strokeText(b.compressSpaces(this.getText()),this.x,this.y)}if(l.fillStyle!=""){l.fillText(b.compressSpaces(this.getText()),this.x,this.y)}};this.getText=function(){};this.measureText=function(l){var j=this.parent.style("font-family").Definition.getDefinition();if(j!=null){var m=this.parent.style("font-size").numValueOrDefault(b.Font.Parse(b.ctx.font).fontSize);var e=0;var k=this.getText();if(j.isRTL){k=k.split("").reverse().join("")}var n=b.ToNumberArray(this.parent.attribute("dx").value);for(var g=0;g<k.length;g++){var h=this.getGlyph(j,k,g);e+=(h.horizAdvX||j.horizAdvX)*m/j.fontFace.unitsPerEm;if(typeof(n[g])!="undefined"&&!isNaN(n[g])){e+=n[g]}}return e}var d=b.compressSpaces(this.getText());if(!l.measureText){return d.length*10}l.save();this.setContext(l);var f=l.measureText(d).width;l.restore();return f}};b.Element.TextElementBase.prototype=new b.Element.RenderedElementBase;b.Element.tspan=function(c){this.base=b.Element.TextElementBase;this.base(c);this.text=c.nodeType==3?c.nodeValue:c.childNodes.length>0?c.childNodes[0].nodeValue:c.text;this.getText=function(){return this.text}};b.Element.tspan.prototype=new b.Element.TextElementBase;b.Element.tref=function(c){this.base=b.Element.TextElementBase;this.base(c);this.getText=function(){var d=this.attribute("xlink:href").Definition.getDefinition();if(d!=null){return d.children[0].getText()}}};b.Element.tref.prototype=new b.Element.TextElementBase;b.Element.a=function(d){this.base=b.Element.TextElementBase;this.base(d);this.hasText=true;for(var c=0;c<d.childNodes.length;c++){if(d.childNodes[c].nodeType!=3){this.hasText=false}}this.text=this.hasText?d.childNodes[0].nodeValue:"";this.getText=function(){return this.text};this.baseRenderChildren=this.renderChildren;this.renderChildren=function(e){if(this.hasText){this.baseRenderChildren(e);var h=new b.Property("fontSize",b.Font.Parse(b.ctx.font).fontSize);b.Mouse.checkBoundingBox(this,new b.BoundingBox(this.x,this.y-h.Length.toPixels("y"),this.x+this.measureText(e),this.y))}else{var f=new b.Element.g();f.children=this.children;f.parent=this;f.render(e)}};this.onclick=function(){window.open(this.attribute("xlink:href").value)};this.onmousemove=function(){b.ctx.canvas.style.cursor="pointer"}};b.Element.a.prototype=new b.Element.TextElementBase;b.Element.image=function(d){this.base=b.Element.RenderedElementBase;this.base(d);b.Images.push(this);this.img=document.createElement("img");this.loaded=false;var c=this;this.img.onload=function(){c.loaded=true};this.img.src=this.attribute("xlink:href").value;this.renderChildren=function(g){var f=this.attribute("x").Length.toPixels("x");var j=this.attribute("y").Length.toPixels("y");var h=this.attribute("width").Length.toPixels("x");var e=this.attribute("height").Length.toPixels("y");if(h==0||e==0){return}g.save();g.translate(f,j);b.AspectRatio(g,this.attribute("preserveAspectRatio").value,h,this.img.width,e,this.img.height,0,0);g.drawImage(this.img,0,0);g.restore()}};b.Element.image.prototype=new b.Element.RenderedElementBase;b.Element.g=function(c){this.base=b.Element.RenderedElementBase;this.base(c);this.getBoundingBox=function(){var e=new b.BoundingBox();for(var d=0;d<this.children.length;d++){e.addBoundingBox(this.children[d].getBoundingBox())}return e}};b.Element.g.prototype=new b.Element.RenderedElementBase;b.Element.symbol=function(c){this.base=b.Element.RenderedElementBase;this.base(c);this.baseSetContext=this.setContext;this.setContext=function(e){this.baseSetContext(e);if(this.attribute("viewBox").hasValue()){var f=b.ToNumberArray(this.attribute("viewBox").value);var d=f[0];var g=f[1];width=f[2];height=f[3];b.AspectRatio(e,this.attribute("preserveAspectRatio").value,this.attribute("width").Length.toPixels("x"),width,this.attribute("height").Length.toPixels("y"),height,d,g);b.ViewPort.SetCurrent(f[2],f[3])}}};b.Element.symbol.prototype=new b.Element.RenderedElementBase;b.Element.style=function(w){this.base=b.Element.ElementBase;this.base(w);var r=w.childNodes[0].nodeValue+(w.childNodes.length>1?w.childNodes[1].nodeValue:"");r=r.replace(/(\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/)|(^[\s]*\/\/.*)/gm,"");r=b.compressSpaces(r);var q=r.split("}");for(var z=0;z<q.length;z++){if(b.trim(q[z])!=""){var D=q[z].split("{");var g=D[0].split(",");var c=D[1].split(";");for(var y=0;y<g.length;y++){var o=b.trim(g[y]);if(o!=""){var e={};for(var x=0;x<c.length;x++){var d=c[x].indexOf(":");var E=c[x].substr(0,d);var v=c[x].substr(d+1,c[x].length-d);if(E!=null&&v!=null){e[b.trim(E)]=new b.Property(b.trim(E),b.trim(v))}}b.Styles[o]=e;if(o=="@font-face"){var B=e["font-family"].value.replace(/"/g,"");var p=e.src.value.split(",");for(var t=0;t<p.length;t++){if(p[t].indexOf('format("svg")')>0){var m=p[t].indexOf("url");var l=p[t].indexOf(")",m);var h=p[t].substr(m+5,l-m-6);var C=b.parseXml(b.ajax(h));var n=C.getElementsByTagName("font");for(var A=0;A<n.length;A++){var u=b.CreateElement(n[A]);b.Definitions[B]=u}}}}}}}}};b.Element.style.prototype=new b.Element.ElementBase;b.Element.use=function(c){this.base=b.Element.RenderedElementBase;this.base(c);this.baseSetContext=this.setContext;this.setContext=function(d){this.baseSetContext(d);if(this.attribute("x").hasValue()){d.translate(this.attribute("x").Length.toPixels("x"),0)}if(this.attribute("y").hasValue()){d.translate(0,this.attribute("y").Length.toPixels("y"))}};this.getDefinition=function(){var d=this.attribute("xlink:href").Definition.getDefinition();if(this.attribute("width").hasValue()){d.attribute("width",true).value=this.attribute("width").value}if(this.attribute("height").hasValue()){d.attribute("height",true).value=this.attribute("height").value}return d};this.path=function(d){var e=this.getDefinition();if(e!=null){e.path(d)}};this.renderChildren=function(d){var e=this.getDefinition();if(e!=null){e.render(d)}}};b.Element.use.prototype=new b.Element.RenderedElementBase;b.Element.mask=function(c){this.base=b.Element.ElementBase;this.base(c);this.apply=function(m,f){var k=this.attribute("x").Length.toPixels("x");var h=this.attribute("y").Length.toPixels("y");var d=this.attribute("width").Length.toPixels("x");var l=this.attribute("height").Length.toPixels("y");var o=f.attribute("mask").value;f.attribute("mask").value="";var j=document.createElement("canvas");j.width=k+d;j.height=h+l;var n=j.getContext("2d");this.renderChildren(n);var g=document.createElement("canvas");g.width=k+d;g.height=h+l;var e=g.getContext("2d");f.render(e);e.globalCompositeOperation="destination-in";e.fillStyle=n.createPattern(j,"no-repeat");e.fillRect(0,0,k+d,h+l);m.fillStyle=e.createPattern(g,"no-repeat");m.fillRect(0,0,k+d,h+l);f.attribute("mask").value=o};this.render=function(d){}};b.Element.mask.prototype=new b.Element.ElementBase;b.Element.clipPath=function(c){this.base=b.Element.ElementBase;this.base(c);this.apply=function(d){for(var e=0;e<this.children.length;e++){if(this.children[e].path){this.children[e].path(d);d.clip()}}};this.render=function(d){}};b.Element.clipPath.prototype=new b.Element.ElementBase;b.Element.filter=function(c){this.base=b.Element.ElementBase;this.base(c);this.apply=function(r,h){var j=h.getBoundingBox();var n=this.attribute("x").Length.toPixels("x");var l=this.attribute("y").Length.toPixels("y");if(n==0||l==0){n=j.x1;l=j.y1}var d=this.attribute("width").Length.toPixels("x");var q=this.attribute("height").Length.toPixels("y");if(d==0||q==0){d=j.width();q=j.height()}var e=h.style("filter").value;h.style("filter").value="";var p=0.2;var o=p*d;var m=p*q;var k=document.createElement("canvas");k.width=d+2*o;k.height=q+2*m;var f=k.getContext("2d");f.translate(-n+o,-l+m);h.render(f);for(var g=0;g<this.children.length;g++){this.children[g].apply(f,0,0,d+2*o,q+2*m)}r.drawImage(k,0,0,d+2*o,q+2*m,n-o,l-m,d+2*o,q+2*m);h.style("filter",true).value=e};this.render=function(d){}};b.Element.filter.prototype=new b.Element.ElementBase;b.Element.feGaussianBlur=function(g){this.base=b.Element.ElementBase;this.base(g);function j(m){m=Math.max(m,0.01);var k=Math.ceil(m*4)+1;mask=[];for(var l=0;l<k;l++){mask[l]=Math.exp(-0.5*(l/m)*(l/m))}return mask}function d(k){var m=0;for(var l=1;l<k.length;l++){m+=Math.abs(k[l])}m=2*m+Math.abs(k[0]);for(var l=0;l<k.length;l++){k[l]/=m}return k}function f(k,r,w,n,v){for(var s=0;s<v;s++){for(var u=0;u<n;u++){var t=e(k,u,s,n,v,3)/255;for(var o=0;o<4;o++){var q=w[0]*(t==0?255:e(k,u,s,n,v,o))*(t==0||o==3?1:t);for(var p=1;p<w.length;p++){var m=e(k,Math.max(u-p,0),s,n,v,3)/255;var l=e(k,Math.min(u+p,n-1),s,n,v,3)/255;q+=w[p]*((m==0?255:e(k,Math.max(u-p,0),s,n,v,o))*(m==0||o==3?1:m)+(l==0?255:e(k,Math.min(u+p,n-1),s,n,v,o))*(l==0||o==3?1:l))}c(r,s,u,v,n,o,q)}}}}function e(m,l,p,o,k,n){return m[p*o*4+l*4+n]}function c(m,l,q,o,k,n,p){m[q*o*4+l*4+n]=p}function h(m,n,k,o){var p=m.getImageData(0,0,n,k);var l=j(o);l=d(l);tmp=[];f(p.data,tmp,l,n,k);f(tmp,p.data,l,k,n);m.clearRect(0,0,n,k);m.putImageData(p,0,0)}this.apply=function(m,l,o,n,k){h(m,n,k,this.attribute("stdDeviation").numValue())}};b.Element.filter.prototype=new b.Element.feGaussianBlur;b.Element.title=function(c){};b.Element.title.prototype=new b.Element.ElementBase;b.Element.desc=function(c){};b.Element.desc.prototype=new b.Element.ElementBase;b.Element.MISSING=function(c){console.log("ERROR: Element '"+c.nodeName+"' not yet implemented.")};b.Element.MISSING.prototype=new b.Element.ElementBase;b.CreateElement=function(d){var c=d.nodeName.replace(/^[^:]+:/,"");c=c.replace(/\-/g,"");var f=null;if(typeof(b.Element[c])!="undefined"){f=new b.Element[c](d)}else{f=new b.Element.MISSING(d)}f.type=d.nodeName;return f};b.load=function(c,d){b.loadXml(c,b.ajax(d))};b.loadXml=function(c,d){b.loadXmlDoc(c,b.parseXml(d))};b.loadXmlDoc=function(g,k){b.init(g);var f=function(m){var l=g.canvas;while(l){m.x-=l.offsetLeft;m.y-=l.offsetTop;l=l.offsetParent}if(window.scrollX){m.x+=window.scrollX}if(window.scrollY){m.y+=window.scrollY}return m};if(b.opts.ignoreMouse!=true){g.canvas.onclick=function(m){var l=f(new b.Point(m!=null?m.clientX:event.clientX,m!=null?m.clientY:event.clientY));b.Mouse.onclick(l.x,l.y)};g.canvas.onmousemove=function(m){var l=f(new b.Point(m!=null?m.clientX:event.clientX,m!=null?m.clientY:event.clientY));b.Mouse.onmousemove(l.x,l.y)}}var j=b.CreateElement(k.documentElement);j.root=true;var h=true;var d=function(){b.ViewPort.Clear();if(g.canvas.parentNode){b.ViewPort.SetCurrent(g.canvas.parentNode.clientWidth,g.canvas.parentNode.clientHeight)}if(b.opts.ignoreDimensions!=true){if(j.style("width").hasValue()){g.canvas.width=j.style("width").Length.toPixels("x");g.canvas.style.width=g.canvas.width+"px"}if(j.style("height").hasValue()){g.canvas.height=j.style("height").Length.toPixels("y");g.canvas.style.height=g.canvas.height+"px"}}var m=g.canvas.clientWidth||g.canvas.width;var l=g.canvas.clientHeight||g.canvas.height;b.ViewPort.SetCurrent(m,l);if(b.opts!=null&&b.opts.offsetX!=null){j.attribute("x",true).value=b.opts.offsetX}if(b.opts!=null&&b.opts.offsetY!=null){j.attribute("y",true).value=b.opts.offsetY}if(b.opts!=null&&b.opts.scaleWidth!=null&&b.opts.scaleHeight!=null){var n=1,e=1;if(j.attribute("width").hasValue()){n=j.attribute("width").Length.toPixels("x")/b.opts.scaleWidth}if(j.attribute("height").hasValue()){e=j.attribute("height").Length.toPixels("y")/b.opts.scaleHeight}j.attribute("width",true).value=b.opts.scaleWidth;j.attribute("height",true).value=b.opts.scaleHeight;j.attribute("viewBox",true).value="0 0 "+(m*n)+" "+(l*e);j.attribute("preserveAspectRatio",true).value="none"}if(b.opts.ignoreClear!=true){g.clearRect(0,0,m,l)}j.render(g);if(h){h=false;if(b.opts!=null&&typeof(b.opts.renderCallback)=="function"){b.opts.renderCallback()}}};var c=true;if(b.ImagesLoaded()){c=false;d()}b.intervalID=setInterval(function(){var l=false;if(c&&b.ImagesLoaded()){c=false;l=true}if(b.opts.ignoreMouse!=true){l=l|b.Mouse.hasEvents()}if(b.opts.ignoreAnimation!=true){for(var e=0;e<b.Animations.length;e++){l=l|b.Animations[e].update(1000/b.FRAMERATE)}}if(b.opts!=null&&typeof(b.opts.forceRedraw)=="function"){if(b.opts.forceRedraw()==true){l=true}}if(l){d();b.Mouse.runEvents()}},1000/b.FRAMERATE)};b.stop=function(){if(b.intervalID){clearInterval(b.intervalID)}};b.Mouse=new (function(){this.events=[];this.hasEvents=function(){return this.events.length!=0};this.onclick=function(c,d){this.events.push({type:"onclick",x:c,y:d,run:function(f){if(f.onclick){f.onclick()}}})};this.onmousemove=function(c,d){this.events.push({type:"onmousemove",x:c,y:d,run:function(f){if(f.onmousemove){f.onmousemove()}}})};this.eventElements=[];this.checkPath=function(f,c){for(var d=0;d<this.events.length;d++){var g=this.events[d];if(c.isPointInPath&&c.isPointInPath(g.x,g.y)){this.eventElements[d]=f}}};this.checkBoundingBox=function(d,g){for(var c=0;c<this.events.length;c++){var f=this.events[c];if(g.isPointInBox(f.x,f.y)){this.eventElements[c]=d}}};this.runEvents=function(){b.ctx.canvas.style.cursor="";for(var d=0;d<this.events.length;d++){var f=this.events[d];var c=this.eventElements[d];while(c){f.run(c);c=c.parent}}this.events=[];this.eventElements=[]}});return b}})();if(CanvasRenderingContext2D){CanvasRenderingContext2D.prototype.drawSvg=function(d,b,a,c,e){canvg(this.canvas,d,{ignoreMouse:true,ignoreAnimation:true,ignoreDimensions:true,ignoreClear:true,offsetX:b,offsetY:a,scaleWidth:c,scaleHeight:e})}}(function(){var b,a;b=(function(){function c(d,f,e){this.meta_data=d!=null?d:null;this.root_dom=f!=null?f:"body";if(e==null){e="svg"}this.root_dom=$(this.root_dom);this.width=500;this.height=500;this.svg_element=this.root_dom.find(e)[0];if(this.meta_data===null){this._populate_data()}}c.prototype._clean_images=function(d){return d.replace(/<image.*?<\/image>/g,"")};c.prototype._populate_data=function(){this.meta_data=[];this.meta_data.push(new Date().toLocaleString());this.meta_data.push("student id: 234433");return this.meta_data.push("Good work.  Next time read the chapters first.")};c.prototype._add_meta_data=function(n){var h,o,l,f,d,j,m,e,k,g;f=$("<text>").attr({x:20,y:10});j=14;l=j*1.4;m=0;d="#442233";g=this.meta_data;for(e=0,k=g.length;e<k;e++){h=g[e];m=m+l;o=$("<tspan>").attr({x:0,y:m,"font-size":j,fill:d});o.append(h);f.append(o)}return n.append(f)};c.prototype.get_svg=function(){var e,d;d=$(this.svg_element).clone();d.attr({width:1000,height:1000});$(d.find("g")[0]).attr({transform:"translate(0,120)"});this._add_meta_data(d);e=$("<div>").append(d);return e.html().replace(/\s+href=/g,"xlink:href=")};c.prototype.get_png=function(){var f,g,d,e;d="tmp_rendering_canvas";g=$("<canvas id='"+d+"' style='display:none;' width="+this.width+" height="+this.height+"></canvas>")[0];this.root_dom.append(g);e=this._clean_images(this.get_svg());canvg(d,e);f=g.toDataURL();$("#"+d).remove();return f};c.prototype.append_png=function(e){var d;if(e==null){e=this.root_dom}d=$("<img>");d.attr("src",this.get_png());return $(e).append(d)};c.prototype.append_svg=function(d){if(d==null){d=this.root_dom}return $(d).append(this.get_svg())};return c})();a=typeof exports!=="undefined"&&exports!==null?exports:this;a.ImageExporter=b}).call(this);(function(){var b=function(g){g=g||{};var c="`";var f=g.referenceIntBase||96;var e=" ".charCodeAt(0);var o=e+f-1;var k=Math.pow(f,2)-1;var d=g.minStringLength||5;var q=Math.pow(f,1)-1+d;var l=g.defaultWindowLength||144;var p=k+d;var h=function(t,s){if((t>=0)&&(t<(Math.pow(f,s)-1))){var u="";while(t>0){u=(String.fromCharCode((t%f)+e))+u;t=Math.floor(t/f)}var v=s-u.length;for(var r=0;r<v;r++){u=String.fromCharCode(e)+u}return u}else{throw"Reference int out of range: "+t+" (width = "+s+")"}};var m=function(r){return h(r-d,1)};var n=function(v,t){var u=0;for(var s=0;s<t;s++){u*=f;var r=v.charCodeAt(s);if((r>=e)&&(r<=o)){u+=r-e}else{throw"Invalid char code in reference int: "+r}}return u};var j=function(r){return n(r,1)+d};this.compress=function(t,r){r=r||l;if(r>p){throw"Window length too large"}var y="";var A=0;var B=t.length-d;while(A<B){var s=Math.max(A-r,0);var u=d;var z=false;var w={distance:k,length:0};var v=null;while((s+u)<A){var x=((t.substr(s,u)==t.substr(A,u))&&(u<q));if(x){u++;z=true}else{var C=u-1;if(z&&(C>w.length)){w.distance=A-s-C;w.length=C}u=d;s++;z=false}}if(w.length){v=c+h(w.distance,2)+m(w.length);A+=w.length}else{if(t.charAt(A)!=c){v=t.charAt(A)}else{v=c+c}A++}y+=v}return y+t.slice(A).replace(/`/g,"``")};this.decompress=function(u){var s="";var x=0;while(x<u.length){var r=u.charAt(x);if(r!=c){s+=r;x++}else{var v=u.charAt(x+1);if(v!=c){var w=n(u.substr(x+1,2),2);var t=j(u.charAt(x+3));s+=s.substr(s.length-w-t,t);x+=d-1}else{s+=c;x+=2}}}return s}};var a=(typeof exports!=="undefined"&&exports!==null)?exports:this;a.LZ77=b}).call(this);(function(){MySystem.parseOldFormatJson=function(f){var e,g;var d=[];containers=f[0].containers;wires=f[0].wires;for(e=0;e<containers.length;++e){g=c(containers[e]);d.push(g)}for(e=0;e<wires.length;++e){b(wires[e],d)}};var c=function(d){return MySystem.store.createRecord(MySystem.Node,{title:d.name,image:a(d.image),position:{x:d.position[0],y:d.position[1]}})};var b=function(h,e){var f=e[Number(h.src.moduleId)];var d=e[Number(h.tgt.moduleId)];var g=MySystem.store.createRecord(MySystem.Link,{startNode:f.get("id"),endNode:d.get("id"),startTerminal:h.src.terminal==="Terminal1"?"a":"b",endTerminal:h.tgt.terminal==="Terminal1"?"a":"b",text:h.options.fields.name});f.get("outLinks").pushObject(g);d.get("inLinks").pushObject(g);return g};var a=function(d){return"http://ccmysystem.appspot.com/"+d}})();function RGBColor(g){this.ok=false;if(g.charAt(0)=="#"){g=g.substr(1,6)}g=g.replace(/ /g,"");g=g.toLowerCase();var a={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};for(var c in a){if(g==c){g=a[c]}}var h=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(j){return[parseInt(j[1]),parseInt(j[2]),parseInt(j[3])]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(j){return[parseInt(j[1],16),parseInt(j[2],16),parseInt(j[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(j){return[parseInt(j[1]+j[1],16),parseInt(j[2]+j[2],16),parseInt(j[3]+j[3],16)]}}];for(var b=0;b<h.length;b++){var e=h[b].re;var d=h[b].process;var f=e.exec(g);if(f){channels=d(f);this.r=channels[0];this.g=channels[1];this.b=channels[2];this.ok=true}}this.r=(this.r<0||isNaN(this.r))?0:((this.r>255)?255:this.r);this.g=(this.g<0||isNaN(this.g))?0:((this.g>255)?255:this.g);this.b=(this.b<0||isNaN(this.b))?0:((this.b>255)?255:this.b);this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"};this.toHex=function(){var l=this.r.toString(16);var k=this.g.toString(16);var j=this.b.toString(16);if(l.length==1){l="0"+l}if(k.length==1){k="0"+k}if(j.length==1){j="0"+j}return"#"+l+k+j};this.getHelpXML=function(){var m=new Array();for(var o=0;o<h.length;o++){var l=h[o].example;for(var n=0;n<l.length;n++){m[m.length]=l[n]}}for(var t in a){m[m.length]=t}var p=document.createElement("ul");p.setAttribute("id","rgbcolor-examples");for(var o=0;o<m.length;o++){try{var q=document.createElement("li");var s=new RGBColor(m[o]);var u=document.createElement("div");u.style.cssText="margin: 3px; border: 1px solid black; background:"+s.toHex()+"; color:"+s.toHex();u.appendChild(document.createTextNode("test"));var k=document.createTextNode(" "+m[o]+" -> "+s.toRGB()+" -> "+s.toHex());q.appendChild(u);q.appendChild(k);p.appendChild(q)}catch(r){}}return p}}MySystem.migrations={migrateLearnerData:function(c){var b=MySystem.learnerDataVersion,d=(typeof c.version==="undefined")?this.detectLegacyLearnerDataVersion(c):c.version,a;if(b===MySystem.DEVELOPMENT_HEAD){if(d===MySystem.DEVELOPMENT_HEAD){return c}else{if(!this.isPositiveInteger(d)){throw new TypeError("data version '%@' is not a positive integer".fmt(d))}a=d;while(MySystem.migrations["migrateLearnerData"+a]){c=MySystem.migrations["migrateLearnerData"+a](c);a++}return c}}else{if(!this.isPositiveInteger(d)){throw new TypeError("data version '%@' is not a positive integer".fmt(d))}if(!this.isPositiveInteger(b)){throw new TypeError("MySystem learnerDataVersion '%@' is not a positive integer".fmt(b))}if(d<b){for(a=d;a<b;a++){c=MySystem.migrations["migrateLearnerData"+a](c)}return c}else{if(d===b){return c}else{throw new RangeError("Current MySystem.learnerDataVersion '%@' is behind the learner-data version '%@'. Down-migrations are not supported.".fmt(MySystem.learnerDataVersion,d))}}}},detectLegacyLearnerDataVersion:function(a){return 1},isPositiveInteger:function(a){return(typeof a==="number"&&Math.round(a)===a&&a>0)},isValidReleaseVersion:function(a){return this.isPositiveInteger(a)}};sc_require("migrations/migrations");MySystem.migrations.migrateLearnerData1=function(f){var c=SC.copy(f,YES),b=f["MySystem.Node"],e=c["MySystem.Node"],a=f["MySystem.Link"],d=c["MySystem.Link"],g;for(g in b){if(!b.hasOwnProperty(g)){continue}if(e[g].position){delete e[g].position;e[g].x=b[g].position.x;e[g].y=b[g].position.y}delete e[g].transformer;delete e[g].transformations}for(g in a){if(!a.hasOwnProperty(g)){continue}delete d[g].label;delete d[g].isSelected}c.version=2;return c};sc_require("migrations/migrations");MySystem.migrations.migrateLearnerData2=function(a){a.version=3;return a};sc_require("migrations/migrations");MySystem.migrations.migrateLearnerData3=function(a){a.version=4;return a};sc_require("migrations/migrations");MySystem.migrations.migrateLearnerData4=function(a){a.version=5;return a};MySystem.ArrowDrawing={arrowPath:function(c,b,k,g,o,d,n,f,j,a){var h=typeof n!=="undefined"&&n!==null?n:15,e=typeof f!=="undefined"&&f!==null?f:20,l=typeof j!=="undefined"&&j!==null?j:0.5,m=typeof a!=="undefined"&&a!==null?a:10;arrowPathArrays=MySystem.ArrowDrawing.arrowPathArrays(c,b,k,g,o,d,h,e,l,m);return{tail:arrowPathArrays[0].join(" "),head:arrowPathArrays[1].join(" ")}},arrowPathArrays:function(e,d,q,o,B,b,C,E,f,G){if(e===q&&d===o){return[[""],[""]]}var g=new this.coord(e,d),v=new this.coord(q,o),D=[],r=[];var w=(v.x-g.x)*f,a=(w===0?1:Math.max(Math.min(w,100),-100)),h=a,n=B?1:-1,x=b?1:-1;a=(a*n>0)?a:a*-1;h=(h*x>0)?h:h*-1;var z=new this.coord(g.x+(w/2),g.y-a),y=new this.coord(v.x-(w/2),v.y-h),m=Math.sqrt(Math.pow((w/2),2)+Math.pow(a,2)),l=G*(w/2)/m,c=G*a/m,s=G*h/m;v=new this.coord(v.x-l,v.y-s);D.push("M",g.x+l,g.y-c);D.push("C",z.x,z.y,y.x,y.y,v.x,v.y);var F=C/this.getLengthOfCubicBezier(g,z,y,v),A=this.getPointOnCubicBezier(F,g,z,y,v),k=Math.atan2((v.y-A.y),(v.x-A.x)),p=k+E*Math.PI/180,j=k-E*Math.PI/180,u=new this.coord(v.x-C*Math.cos(p),v.y-C*Math.sin(p)),t=new this.coord(v.x-C*Math.cos(j),v.y-C*Math.sin(j));r.push("M",v.x,v.y);r.push("L",u.x,u.y);r.push("L",t.x,t.y);r.push("L",v.x,v.y);return[D,r]},getPointOnCubicBezier:function(d,e,c,b,a){if(d<0){d=0}if(d>1){d=1}var f=new this.coord();f.x=e.x*this.B1(d)+c.x*this.B2(d)+b.x*this.B3(d)+a.x*this.B4(d);f.y=e.y*this.B1(d)+c.y*this.B2(d)+b.y*this.B3(d)+a.y*this.B4(d);return f},getLengthOfCubicBezier:function(j,h,e,d){var f=10,a=0,l,k,c;for(i=0;i<f;i++){l=i/f;k=this.getPointOnCubicBezier(l,j,h,e,d);if(i>0){var g=k.x-c.x,b=k.y-c.y;a+=Math.sqrt((g*g)+(b*b))}c=k}return a},coord:function(a,b){if(!a){a=0}if(!b){b=0}a=Math.round(a*1000)/1000;b=Math.round(b*1000)/1000;return{x:a,y:b}},B1:function(a){return a*a*a},B2:function(a){return 3*a*a*(1-a)},B3:function(a){return 3*a*(1-a)*(1-a)},B4:function(a){return(1-a)*(1-a)*(1-a)}};MySystem.Activity=SC.Record.extend({paletteItems:SC.Record.toMany("MySystem.PaletteItem"),assignmentText:SC.Record.attr(String),energyTypes:SC.Record.toMany("MySystem.EnergyType"),diagramRules:SC.Record.toMany("MySystem.DiagramRule"),rubricCategories:SC.Record.toMany("MySystem.RubricCategory"),rubricExpression:SC.Record.attr(String),minimumRequirements:SC.Record.toMany("MySystem.DiagramRule"),minimumRequirementsFeedback:SC.Record.attr(String),enableNodeLabelDisplay:SC.Record.attr(Boolean,{defaultValue:true}),enableNodeLabelEditing:SC.Record.attr(Boolean,{defaultValue:false}),enableNodeDescriptionEditing:SC.Record.attr(Boolean,{defaultValue:false}),enableLinkDescriptionEditing:SC.Record.attr(Boolean,{defaultValue:false}),enableLinkLabelEditing:SC.Record.attr(Boolean,{defaultValue:false}),maxFeedbackItems:SC.Record.attr(Number,{defaultValue:0}),correctFeedback:SC.Record.attr(String,{defaultValue:"Your diagram has no obvious problems."}),enableCustomRuleEvaluator:SC.Record.attr(Boolean,{defaultValue:false}),customRuleEvaluator:SC.Record.attr(String),maxSubmissionClicks:SC.Record.attr(Number,{defaultValue:0}),maxSubmissionFeedback:SC.Record.attr(String,{defaultValue:"You have clicked 'submit' too many times. Please continue working without hints."}),feedbackPanelWidth:SC.Record.attr(Number,{defaultValue:500}),feedbackPanelHeight:SC.Record.attr(Number,{defaultValue:250}),terminalRadius:SC.Record.attr(Number,{defaultValue:10}),nodeHeight:SC.Record.attr(Number,{defaultValue:110}),nodeWidth:SC.Record.attr(Number,{defaultValue:100}),backgroundImage:SC.Record.attr(String,{defaultValue:null}),backgroundImageScaling:SC.Record.attr(Boolean,{defaultValue:false})});MySystem.Activity.GuidCounter=100;MySystem.Activity.newGuid=function(a){return a+MySystem.Activity.GuidCounter++};MySystem.Activity.fromWiseStepDef=function(g){var k=MySystem.Activity.newGuid("actvitiy");var f=g.modules;var e=null;var a=null;var c=MySystem.store.createRecord(MySystem.Activity,{assignmentText:g.prompt,maxFeedbackItems:(g.maxFeedbackItems||0),enableNodeLabelDisplay:(g.enableNodeLabelDisplay||false),enableNodeLabelEditing:(g.enableNodeLabelEditing||false),enableNodeDescriptionEditing:(g.enableNodeDescriptionEditing||false),enableLinkDescriptionEditing:(g.enableLinkDescriptionEditing||false),enableLinkLabelEditing:(g.enableLinkLabelEditing||false),minimumRequirementsFeedback:(g.minimumRequirementsFeedback||"You need to work more on your diagram to get feedback!"),correctFeedback:(g.correctFeedback||"Your diagram has no obvious problems."),guid:MySystem.Activity.newGuid("activity"),enableCustomRuleEvaluator:(g.enableCustomRuleEvaluator||false),customRuleEvaluator:(g.customRuleEvaluator||""),maxSubmissionClicks:(g.maxSubmissionClicks||0),maxSubmissionFeedback:(g.maxSubmissionFeedback||"You have clicked 'submit' too many times. Please continue working without hints."),feedbackPanelWidth:(g.feedbackPanelWidth||500),feedbackPanelHeight:(g.feedbackPanelHeight||250),terminalRadius:(g.terminalRadius||14),nodeHeight:(g.nodeHeight||110),nodeWidth:(g.nodeWidth||100),backgroundImage:(g.backgroundImage||null),backgroundImageScaling:(g.backgroundImageScaling||false),rubricExpression:(g.rubricExpression||"")});var r=f.length;var j=0;for(j=0;j<r;j++){a=f[j];e=MySystem.store.createRecord(MySystem.PaletteItem,{title:a.name,image:a.image,uuid:a.uuid},MySystem.Activity.newGuid("palette_item"));c.get("paletteItems").pushObject(e)}var b=g.energy_types;r=b.length;var m="";var o=null;for(j=0;j<r;j++){m=b[j];o=MySystem.store.createRecord(MySystem.EnergyType,{label:m.label,color:m.color,isEnabled:YES,uuid:m.uuid},MySystem.Activity.newGuid("energyType"));c.get("energyTypes").pushObject(o)}var q=(g.minimum_requirements||[]);r=q.length;var h=null;var n=null;for(j=0;j<r;j++){n=q[j];h=MySystem.store.createRecord(MySystem.DiagramRule,n,MySystem.Activity.newGuid("diagramRule"));c.get("minimumRequirements").pushObject(h)}var d=g.diagram_rules;r=d.length;h=null;n=null;for(j=0;j<r;j++){n=d[j];h=MySystem.store.createRecord(MySystem.DiagramRule,n,MySystem.Activity.newGuid("diagramRule"));c.get("diagramRules").pushObject(h)}var l=g.rubric_categories;var p=null;if(l){r=l.length;p=null;n=null;for(j=0;j<r;j++){n=l[j];p=MySystem.store.createRecord(MySystem.RubricCategory,n,MySystem.Activity.newGuid("rubricCategory"));c.get("rubricCategories").pushObject(p)}}return c};MySystem.DiagramRule=SC.Record.extend({suggestion:SC.Record.attr(String),comparison:SC.Record.attr(String),number:SC.Record.attr(Number),name:SC.Record.attr(String),category:SC.Record.attr(String),type:SC.Record.attr(String),isJavascript:SC.Record.attr(Boolean,{defaultValue:NO}),hasLink:SC.Record.attr(Boolean),linkDirection:SC.Record.attr(String),otherNodeType:SC.Record.attr(String),energyType:SC.Record.attr(String),javascriptExpression:SC.Record.attr(String),not:SC.Record.attr(Boolean,{defaultValue:NO}),paletteItem:function(a){if(a=="node"){return MySystem.DiagramRule.genericPaletteItem}var c=SC.Query.local(MySystem.PaletteItem,"title = {title}",{title:a});var b=MySystem.store.find(c);if(b.get("length")>0){return b.objectAt(0)}else{return null}},energyTypeObject:function(){var b=this.get("energyType");if(!b||b=="any"){return MySystem.DiagramRule.genericEnergyType}var c=SC.Query.local(MySystem.EnergyType,"label = {label}",{label:b});var a=MySystem.store.find(c);if(a.get("length")>0){return a.objectAt(0)}else{return null}},check:function(a,d){if(this.get("isJavascript")){return(this.js_check(a,d))}var c=this.matches(a);var b;switch(this.get("comparison")){case"more than":b=c>this.get("number");break;case"less than":b=c<this.get("number");break;case"exactly":b=c==this.get("number");break;default:throw"Invalid comparison value for diagram rule."}if(this.get("not")){return !b}return b},checkNode:function(b,a){if(b===null){return false}else{if(b===MySystem.DiagramRule.genericPaletteItem){return true}else{return b.get("uuid")==a.get("nodeType")}}},checkLink:function(c,d,a){var b=this.energyTypeObject();if(!b){return false}if((b!=MySystem.DiagramRule.genericEnergyType)&&(b.get("uuid")!=c.get("energyType"))){return false}return this.checkNode(d,c.get("startNode"))&&this.checkNode(a,c.get("endNode"))},js_check:function(nodes,evaluator){var self=this;var javascript=this.get("javascriptExpression");var ruleName=this.get("name");var Rules=evaluator;var diagram=evaluator;var name=ruleName;var result=false;var errorMsg="Rule Evaluation Error: rule# %@:\n%@";(function(){try{eval(javascript)}catch(e){errorMsg=errorMsg.fmt(ruleName,e);if(console&&typeof console.log=="function"){console.log(errorMsg)}alert(errorMsg)}}).call(self);return result},matches:function(b){var d=this.paletteItem(this.get("type")),e=0;if(this.get("hasLink")){var c=this.paletteItem(this.get("otherNodeType")),a=MySystem.store.find(MySystem.Link);switch(this.get("linkDirection")){case"-->":a.forEach(function(f){if(f.isComplete()&&this.checkLink(f,d,c)){e++}},this);break;case"<--":a.forEach(function(f){if(f.isComplete()&&this.checkLink(f,c,d)){e++}},this);break;case"---":a.forEach(function(f){if(f.isComplete()&&(this.checkLink(f,d,c)||this.checkLink(f,c,d))){e++}},this);break;default:throw"Invalid linkDirection value for diagram rule."}return e}else{if(d===null){return false}else{if(d===MySystem.DiagramRule.genericPaletteItem){return b.get("length")}else{b.forEach(function(f){if(this.checkNode(d,f)){e++}},this);return e}}}}});MySystem.DiagramRule.genericPaletteItem="genericPaletteItem";MySystem.DiagramRule.genericEnergyType="genericEnergyType";MySystem.Diagrammable=MySystem.AutoGuidRecord.extend({x:SC.Record.attr(Number),y:SC.Record.attr(Number),});MySystem.Diagrammable.isPolymorphic=YES;MySystem.EnergyType=SC.Record.extend({label:SC.Record.attr(String,{isRequired:YES,defaultValue:"Energy Flow"}),color:SC.Record.attr(String,{isRequired:YES}),isEnabled:SC.Record.attr(Boolean,{isRequired:YES,defaultValue:YES}),uuid:SC.Record.attr(String)});MySystem.GraphicPreview=SC.Record.extend({timeStamp:SC.Record.attr(String),svg:SC.Record.attr(String),png:SC.Record.attr(String),updatePreview:function(a){var c=[],b;this.set("timeStamp",new Date());c.push("submit time: "+this.get("timeStamp").toLocaleString());if(!!a){c.push("No. Sumbits: "+a.get("numOfSubmits"));c.push("Feedback:    "+a.get("feedback"))}b=this.getExporter(c);this.set("svg",escape(new LZ77().compress(b.get_svg())))},getExporter:function(a){return new ImageExporter(a)}});MySystem.GraphicPreview.LAST_FEEDBACK_GUID="LAST_GRAPHIC_PREVIEW";MySystem.GraphicPreview.instance=function(){var a=MySystem.store;var b=a.find(MySystem.GraphicPreview,MySystem.GraphicPreview.LAST_FEEDBACK_GUID);if(b&&(b.get("status")&SC.Record.READY)){return b}b=a.createRecord(MySystem.GraphicPreview,{timeStamp:new Date()},MySystem.GraphicPreview.LAST_FEEDBACK_GUID);a.flush();a.commitRecords();return b};MySystem.GraphicPreview.makePreview=function(a){var b=a.find(MySystem.RuleFeedback,MySystem.RuleFeedback.LAST_FEEDBACK_GUID);var c=MySystem.GraphicPreview.instance(a);c.updatePreview(b);a.flush();a.commitRecords()};sc_require("models/diagrammable");MySystem.Link=MySystem.Diagrammable.extend({color:SC.Record.attr(String),text:SC.Record.attr(String),description:SC.Record.attr(String),energyType:SC.Record.attr(String),startNode:SC.Record.toOne("MySystem.Node",{inverse:"outLinks"}),endNode:SC.Record.toOne("MySystem.Node",{inverse:"inLinks"}),sentences:SC.Record.toMany("MySystem.StorySentence",{inverse:"links",isMaster:NO}),energyTypeObj:function(){var a=this.get("energyType");if(SC.none(a)){return null}return MySystem.getPath("activityController.energyTypes").findProperty("uuid",this.get("energyType"))}.property("energyType"),energyTypeObjDidChange:function(){var a=this.get("energyTypeObj");if(SC.none(a)||this.isDestroyed()){return}this.set("text",a.get("label"));this.set("color",a.get("color"))}.observes("energyTypeObj"),startTerminal:SC.Record.attr(String),endTerminal:SC.Record.attr(String),isDimmed:NO,init:function(){arguments.callee.base.apply(this,arguments)},isComplete:function(){var a=this.get("startNode");var c=this.get("endNode");var d=this.get("startTerminal");var b=this.get("endTerminal");if(this.isDestroyed()){return false}if(SC.none(a)){return false}if(SC.none(c)){return false}if(SC.none(d)){return false}if(SC.none(b)){return false}if(a.isDestroyed()){return false}if(c.isDestroyed()){return false}return true},_textChanged:function(){if(this.get("startNode")){this.get("startNode").notifyPropertyChange("links")}if(this.get("endNode")){this.get("endNode").notifyPropertyChange("links")}}.observes(".text"),_colorChanged:function(){if(this.get("startNode")){this.get("startNode").notifyPropertyChange("links")}if(this.get("endNode")){this.get("endNode").notifyPropertyChange("links")}}.observes(".color"),dimColor:function(){if(this.get("isDimmed")===YES){var g,b,a;g=this.get("color");b={};var h=MySystem.Link.COLOR_DEFS;for(var c=0;c<h.length;c++){var e=h[c].re;var d=h[c].process;var f=e.exec(g);if(f){a=d(f);b.r=a[0];b.g=a[1];b.b=a[2];b.a=(a[3]?a[3]:1);b.ok=true}}if(b.r!==undefined){b.a=b.a*0.2;this.set("color","rgba("+b.r.toString()+", "+b.g.toString()+", "+b.b.toString()+", "+b.a.toString()+")");return YES}else{SC.Logger.log("No matching color pattern found.");return NO}}}.observes("isDimmed"),unDimColor:function(){if(!this.get("isDimmed")){var g,b,a;g=this.get("color");b={};var h=MySystem.Link.COLOR_DEFS;for(var c=0;c<h.length;c++){var e=h[c].re;var d=h[c].process;var f=e.exec(g);if(f){a=d(f);b.r=a[0];b.g=a[1];b.b=a[2];b.a=(a[3]?a[3]:1);b.ok=true}}if(b.r!==undefined){b.a=b.a*5;if(b.a>1){b.a=1}if(!this.get("isDestroyed")){this.set("color","rgba("+b.r.toString()+", "+b.g.toString()+", "+b.b.toString()+", "+b.a.toString()+")")}return YES}else{SC.Logger.log("No matching color pattern found.");return NO}}}.observes("isDimmed"),fixSelectionDimming:function(){if(this.get("isSelected")&&this.get("isDimmed")){this.set("isDimmed",NO)}},destroy:function(){var b=this.get("startNode");var a=this.get("endNode");if(!!b&&(b.get("status")&SC.Record.READY)){b.get("inLinks").removeObject(this);b.get("outLinks").removeObject(this)}if(!!a&&(a.get("status")&SC.Record.READY)){a.get("inLinks").removeObject(this);a.get("outLinks").removeObject(this)}arguments.callee.base.apply(this,arguments)}});MySystem.Link.COLOR_DEFS=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(a){return[parseInt(a[1],10),parseInt(a[2],10),parseInt(a[3],10)]}},{re:/^\#?(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(a){return[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]}},{re:/^\#?(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(a){return[parseInt(a[1]+a[1],16),parseInt(a[2]+a[2],16),parseInt(a[3]+a[3],16)]}},{re:/^rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3}),\s*([\d.]+)\)$/,example:["rgba(123, 234, 45, 1.0)","rgb(255,234,245,0.3333333)"],process:function(a){return[parseInt(a[1],10),parseInt(a[2],10),parseInt(a[3],10),parseInt(a[4],10)]}}];sc_require("models/diagrammable");MySystem.Node=MySystem.Diagrammable.extend({image:SC.Record.attr(String),title:SC.Record.attr(String),description:SC.Record.attr(String),transformer:SC.Record.attr(Boolean,{defaultValue:true}),toolTip:SC.Record.attr(String,{defaultValue:null}),nodeType:SC.Record.attr(String),outLinks:SC.Record.toMany("MySystem.Link",{inverse:"startNode",isMaster:YES}),inLinks:SC.Record.toMany("MySystem.Link",{inverse:"endNode",isMaster:YES}),sentences:SC.Record.toMany("MySystem.StorySentence",{inverse:"nodes",isMaster:NO}),terminals:["a","b"],init:function(){arguments.callee.base.apply(this,arguments)},destroy:function(){var a=this.get("outLinks").toArray().concat(this.get("inLinks").toArray());for(var b=0,c=a.length;b<c;b++){a[b].destroy()}SC.Logger.log("destroy called on ",this);arguments.callee.base.apply(this,arguments)},intersection:function(g,f){if(g===null){return f}if(f===null){return g}var a=[];for(var e=0;e<g.length;e+=1){var d=g[e];for(var c=0;c<f.length;c+=1){var b=f[c];if(d===b){a.push(d)}}}return a},addInLink:function(a){this.get("outLinks").pushObject(a)},addOutLink:function(a){this.get("inLinks").pushObject(a)}});MySystem.PaletteItem=SC.Record.extend({image:SC.Record.attr(String),title:SC.Record.attr(String),uuid:SC.Record.attr(String)});MySystem.RubricCategory=SC.Record.extend({name:SC.Record.attr(String),ruleNames:SC.Record.attr(String),rules:function(){var c=this.get("ruleNames");var b;var a=[];if(c&&c.split(",")){c=c.split(",");names=c.forEach(function(d){b=SC.Query.local(MySystem.DiagramRule,"name = {name}",{name:d});a.push(MySystem.store.find(b))})}return a}.property("ruleNames").cacheable(),addRule:function(a){var b=this.get("ruleNames")||"";b=b.split(",");b.push(a);this.set("ruleNames",b.join(","))},getRules:function(){return this.get("rules")},check:function(a,d){var c=this.getRules();var b=false;c.forEach(function(e){if(e.check(a,d)){b=true}});return b}});MySystem.RubricScore=SC.Record.extend({timeStamp:SC.Record.attr(String),score:SC.Record.attr(Number),categories:SC.Record.attr(String),update:function(e,a){var d=[],c;var b=new Date().getTime();this.set("timeStamp",b);this.set("score",e);this.set("categories",a)}});MySystem.RubricScore.LAST_SCORE_ID="LAST_SCORE_ID";MySystem.RubricScore.instance=function(){var a=MySystem.store;var b=a.find(MySystem.RubricScore,MySystem.RubricScore.LAST_SCORE_ID);if(b&&(b.get("status")&SC.Record.READY)){return b}b=a.createRecord(MySystem.RubricScore,{timeStamp:new Date()},MySystem.RubricScore.LAST_SCORE_ID);a.flush();a.commitRecords();return b};MySystem.RuleFeedback=SC.Record.extend({feedback:SC.Record.attr(String),success:SC.Record.attr(Boolean),numOfSubmits:SC.Record.attr(Number,{defaultValue:0}),timeStamp:SC.Record.attr(String),timeStampMs:SC.Record.attr(Number)});MySystem.RuleFeedback.LAST_FEEDBACK_GUID="LAST_FEEDBACK";MySystem.RuleFeedback.saveFeedback=function(c,a,g,d){var e=c.find(MySystem.RuleFeedback,MySystem.RuleFeedback.LAST_FEEDBACK_GUID);var b=new Date();var f=b.getTime();if(e&&(e.get("status")&SC.Record.READY)){e.set({feedback:a,success:g,timeStamp:b,timeStampMs:f});if(d){e.set("numOfSubmits",e.get("numOfSubmits")+1)}}else{c.createRecord(MySystem.RuleFeedback,{feedback:a,success:g,numOfSubmits:(d?1:0),timeStamp:b,timeStampMs:f},MySystem.RuleFeedback.LAST_FEEDBACK_GUID)}c.flush();c.commitRecords()};MySystem.Story=SC.Record.extend({storyHtml:SC.Record.attr(String)});MySystem.StorySentence=SC.Record.extend({order:SC.Record.attr(Number),bodyText:SC.Record.attr(String),nodes:SC.Record.toMany("MySystem.Node",{inverse:"sentences",isMaster:NO}),links:SC.Record.toMany("MySystem.Link",{inverse:"sentences",isMaster:NO}),diagramObjects:function(){var a=[],c=this.get("nodes"),b=this.get("links");c.forEach(function(f,e,d){this.pushObject(f)},a);b.forEach(function(f,e,d){this.pushObject(f)},a);return a}.property().cacheable(),_diagramObjectsDidChange:function(){this.notifyPropertyChange("diagramObjects")}.observes(".nodes.[]",".links.[]")});MySystem.StorySentence.GuidCounter=100;MySystem.StorySentence.newGuid=function(){return"ss"+MySystem.StorySentence.GuidCounter++};MySystem.StudentState=SC.Record.extend({content:SC.Record.attr(String),timestamp:SC.Record.attr(Number)});MySystem.Theme=SC.AceTheme.create({name:"mysystem-theme"});SC.Theme.addTheme(MySystem.Theme);SC.defaultTheme="mysystem-theme";sc_require("theme");MySystem.Theme.radioRenderDelegate=SC.RenderDelegate.create({className:"radio",render:function(c,b){var a=c.get("color");if(a){b.css("background-color",a);b.css("color","#FFFFFF")}b.css("font-weight","bold");SC.BaseTheme.radioRenderDelegate.render(c,b)},update:function(c,b){var a=c.get("color");b.css("background-color",a?a:null);b.css("color",a?"#FFFFFF":null);SC.BaseTheme.radioRenderDelegate.update(c,b)}});MySystem._tempStudentData=[{containers:[{terminals:[{wireConfig:{drawingMethod:"bezierArrows"},name:"Terminal1",direction:[0,-1],offsetPosition:{left:20,top:-25},ddConfig:{type:"input",allowedTypes:["input","output"]}},{wireConfig:{drawingMethod:"bezierArrows"},name:"Terminal2",direction:[0,1],offsetPosition:{left:20,bottom:-50},ddConfig:{type:"output",allowedTypes:["input","output"]}}],draggable:true,position:["375px","430px"],className:"WireIt-Container WireIt-ImageContainer",ddHandle:false,ddHandleClassName:"WireIt-Container-ddhandle",resizable:false,resizeHandleClassName:"WireIt-Container-resizehandle",close:true,closeButtonClassName:"WireIt-Container-closebutton",icon:"./images/cleardemo/earth.png",preventSelfWiring:true,image:"./images/cleardemo/earth.png",xtype:"MySystemContainer",fields:{name:"Earth",energy:100,efficiency:1,energy_transform:true},name:"Earth",has_sub:false},{terminals:[{wireConfig:{drawingMethod:"bezierArrows"},name:"Terminal1",direction:[0,-1],offsetPosition:{left:20,top:-25},ddConfig:{type:"input",allowedTypes:["input","output"]}},{wireConfig:{drawingMethod:"bezierArrows"},name:"Terminal2",direction:[0,1],offsetPosition:{left:20,bottom:-50},ddConfig:{type:"output",allowedTypes:["input","output"]}}],draggable:true,position:["605px","426px"],className:"WireIt-Container WireIt-ImageContainer",ddHandle:false,ddHandleClassName:"WireIt-Container-ddhandle",resizable:false,resizeHandleClassName:"WireIt-Container-resizehandle",close:true,closeButtonClassName:"WireIt-Container-closebutton",icon:"./images/cleardemo/atmosphere.png",preventSelfWiring:true,image:"./images/cleardemo/atmosphere.png",xtype:"MySystemContainer",fields:{name:"Atmosphere",efficiency:1},name:"Atmosphere",has_sub:false},{terminals:[{wireConfig:{drawingMethod:"bezierArrows"},name:"Terminal1",direction:[0,-1],offsetPosition:{left:20,top:-25},ddConfig:{type:"input",allowedTypes:["input","output"]}},{wireConfig:{drawingMethod:"bezierArrows"},name:"Terminal2",direction:[0,1],offsetPosition:{left:20,bottom:-50},ddConfig:{type:"output",allowedTypes:["input","output"]}}],draggable:true,position:["171px","434px"],className:"WireIt-Container WireIt-ImageContainer",ddHandle:false,ddHandleClassName:"WireIt-Container-ddhandle",resizable:false,resizeHandleClassName:"WireIt-Container-resizehandle",close:true,closeButtonClassName:"WireIt-Container-closebutton",icon:"./images/cleardemo/ggases.png",preventSelfWiring:true,image:"./images/cleardemo/ggases.png",xtype:"MySystemContainer",fields:{name:"Gasses",energy:100,efficiency:1,energy_store:true},name:"Gasses",has_sub:false},{terminals:[{wireConfig:{drawingMethod:"bezierArrows"},name:"Terminal1",direction:[0,-1],offsetPosition:{left:20,top:-25},ddConfig:{type:"input",allowedTypes:["input","output"]}},{wireConfig:{drawingMethod:"bezierArrows"},name:"Terminal2",direction:[0,1],offsetPosition:{left:20,bottom:-50},ddConfig:{type:"output",allowedTypes:["input","output"]}}],draggable:true,position:["327px","223px"],className:"WireIt-Container WireIt-ImageContainer",ddHandle:false,ddHandleClassName:"WireIt-Container-ddhandle",resizable:false,resizeHandleClassName:"WireIt-Container-resizehandle",close:true,closeButtonClassName:"WireIt-Container-closebutton",icon:"./images/cleardemo/sun.png",preventSelfWiring:true,image:"./images/cleardemo/sun.png",xtype:"MySystemContainer",fields:{name:"Sun",energy:100,efficiency:1,energy_transform:true},name:"Sun",has_sub:false},{terminals:[{wireConfig:{drawingMethod:"bezierArrows"},name:"Terminal1",direction:[0,-1],offsetPosition:{left:20,top:-25},ddConfig:{type:"input",allowedTypes:["input","output"]}},{wireConfig:{drawingMethod:"bezierArrows"},name:"Terminal2",direction:[0,1],offsetPosition:{left:20,bottom:-50},ddConfig:{type:"output",allowedTypes:["input","output"]}}],draggable:true,position:["540px","216px"],className:"WireIt-Container WireIt-ImageContainer",ddHandle:false,ddHandleClassName:"WireIt-Container-ddhandle",resizable:false,resizeHandleClassName:"WireIt-Container-resizehandle",close:true,closeButtonClassName:"WireIt-Container-closebutton",icon:"./images/cleardemo/space.png",preventSelfWiring:true,image:"./images/cleardemo/space.png",xtype:"MySystemContainer",fields:{name:"Space",energy:100,efficiency:1,energy_make:true},name:"Space",has_sub:false},{terminals:[{wireConfig:{drawingMethod:"bezierArrows"},name:"Terminal1",direction:[0,-1],offsetPosition:{left:20,top:-25},ddConfig:{type:"input",allowedTypes:["input","output"]}},{wireConfig:{drawingMethod:"bezierArrows"},name:"Terminal2",direction:[0,1],offsetPosition:{left:20,bottom:-50},ddConfig:{type:"output",allowedTypes:["input","output"]}}],draggable:true,position:["114px","267px"],className:"WireIt-Container WireIt-ImageContainer",ddHandle:false,ddHandleClassName:"WireIt-Container-ddhandle",resizable:false,resizeHandleClassName:"WireIt-Container-resizehandle",close:true,closeButtonClassName:"WireIt-Container-closebutton",icon:"./images/cleardemo/lowalbedo.png",preventSelfWiring:true,image:"./images/cleardemo/lowalbedo.png",xtype:"MySystemContainer",fields:{name:"Low Albedo",energy:100,efficiency:1,energy_make:true},name:"Low Albedo",has_sub:false},{terminals:[],draggable:true,position:["675px","203px"],className:"MySystemNote",ddHandle:true,ddHandleClassName:"WireIt-Container-ddhandle",resizable:true,resizeHandleClassName:"WireIt-Container-resizehandle",close:true,closeButtonClassName:"WireIt-Container-closebutton",title:"Note",preventSelfWiring:true,fields:{content:"I have no idea how the energy \u000atransfers.\u000a"},xtype:"MySystemNote",name:"Note"},{terminals:[{wireConfig:{drawingMethod:"bezierArrows"},name:"Terminal1",direction:[0,-1],offsetPosition:{left:20,top:-25},ddConfig:{type:"input",allowedTypes:["input","output"]}},{wireConfig:{drawingMethod:"bezierArrows"},name:"Terminal2",direction:[0,1],offsetPosition:{left:20,bottom:-50},ddConfig:{type:"output",allowedTypes:["input","output"]}}],draggable:true,position:["494px","422px"],className:"WireIt-Container WireIt-ImageContainer",ddHandle:false,ddHandleClassName:"WireIt-Container-ddhandle",resizable:false,resizeHandleClassName:"WireIt-Container-resizehandle",close:true,closeButtonClassName:"WireIt-Container-closebutton",icon:"./images/cleardemo/clouds.png",preventSelfWiring:true,image:"./images/cleardemo/clouds.png",xtype:"MySystemContainer",fields:{name:"Clouds",energy:100,efficiency:1,energy_store:true},name:"Clouds",has_sub:false}],wires:[{src:{moduleId:3,terminal:"Terminal2"},tgt:{moduleId:2,terminal:"Terminal1"},options:{className:"WireIt-Wire",coeffMulDirection:100,drawingMethod:"bezierArrows",cap:"round",bordercap:"round",width:5,borderwidth:1,color:"rgb(233, 127, 2)",bordercolor:"#000000",fields:{name:"To greenhouse",width:5,color:"rgb(233, 127, 2)"},selected:true,name:"To greenhouse",last_color:"rgb(233, 127, 2)"}},{src:{moduleId:3,terminal:"Terminal2"},tgt:{moduleId:1,terminal:"Terminal1"},options:{className:"WireIt-Wire",coeffMulDirection:100,drawingMethod:"bezierArrows",cap:"round",bordercap:"round",width:5,borderwidth:1,color:"rgb(233, 127, 2)",bordercolor:"#000000",fields:{name:"(type-here)",width:5,color:"rgb(233, 127, 2)"},selected:false,last_color:"rgb(233, 127, 2)",name:"(type-here)"}},{src:{moduleId:3,terminal:"Terminal2"},tgt:{moduleId:0,terminal:"Terminal1"},options:{className:"WireIt-Wire",coeffMulDirection:100,drawingMethod:"bezierArrows",cap:"round",bordercap:"round",width:5,borderwidth:1,color:"rgb(233, 127, 2)",bordercolor:"#000000",fields:{name:"Solar radiation to Earth",width:5,color:"rgb(233, 127, 2)"},selected:true,name:"Solar radiation to Earth",last_color:"rgb(233, 127, 2)"}},{src:{moduleId:0,terminal:"Terminal2"},tgt:{moduleId:2,terminal:"Terminal1"},options:{className:"WireIt-Wire",coeffMulDirection:100,drawingMethod:"bezierArrows",cap:"round",bordercap:"round",width:5,borderwidth:1,color:"rgb(189, 21, 80)",bordercolor:"#000000",fields:{name:"Entrapment",width:5,color:"rgb(189, 21, 80)"},selected:true,name:"Entrapment",last_color:"rgb(189, 21, 80)"}},{src:{moduleId:3,terminal:"Terminal2"},tgt:{moduleId:4,terminal:"Terminal1"},options:{className:"WireIt-Wire",coeffMulDirection:100,drawingMethod:"bezierArrows",cap:"round",bordercap:"round",width:5,borderwidth:1,color:"rgb(233, 127, 2)",bordercolor:"#000000",fields:{name:"To space",width:5,color:"rgb(233, 127, 2)"},selected:false,name:"To space",last_color:"rgb(233, 127, 2)"}},{src:{moduleId:0,terminal:"Terminal2"},tgt:{moduleId:7,terminal:"Terminal1"},options:{className:"WireIt-Wire",coeffMulDirection:100,drawingMethod:"bezierArrows",cap:"round",bordercap:"round",width:5,borderwidth:1,color:"rgb(189, 21, 80)",bordercolor:"#000000",fields:{name:"To clouds",width:5,color:"rgb(189, 21, 80)"},selected:true,name:"To clouds"}}]}];MySystem.DIAGRAM_EDITING=SC.State.design({enterState:function(){SC.Logger.log("Entering state %s",this.get("name"))},exitState:function(){SC.Logger.log("Leaving state %s",this.get("name"))},addNode:function(a){var b;b=MySystem.store.createRecord(MySystem.Node,{title:a.title,image:a.image,x:a.x,y:a.y,nodeType:a.nodeType});MySystem.nodesController.deselectObjects(MySystem.nodesController.get("selection"));MySystem.nodesController.selectObject(b);return YES},diagramSelectionChanged:function(){var a=MySystem.nodesController.get("selection");if((a.get("length")==1)&&MySystem.nodesController.objectIsInspectable(a.firstObject())){this.gotoState("DIAGRAM_OBJECT_EDITING")}return YES},editSentence:function(){this.gotoState("SENTENCE_EDITING");return YES},sentenceDiagramConnect:function(a){MySystem.storySentenceController.set("editingSentence",a.sentence);this.gotoState("SENTENCE_OBJECT_LINKING_SETUP");return YES}});MySystem.DIAGRAM_OBJECT_EDITING=SC.State.design({setUpInspectorPane:function(){var a=MySystem.getPath("mainPage.inspectorPane");a.set("isOptionsForNewLink",NO);a.set("isModal",NO);if(!a.isPaneAttached){a.append()}},deleteObject:function(){var a=MySystem.getPath("mainPage.inspectorPane");return YES},tearDownInspectorPane:function(){var a=MySystem.getPath("mainPage.inspectorPane");if(a.isPaneAttached){a.remove()}},enterState:function(){SC.Logger.log("Entering state %s",this.get("name"));if(MySystem.nodesController.get("selectionIsInspectable")){this.setUpInspectorPane()}else{this.tearDownInspectorPane();this.gotoState("DIAGRAM_EDITING")}},exitState:function(){SC.Logger.log("Leaving state %s",this.get("name"));this.tearDownInspectorPane()},diagramSelectionChanged:function(){if(MySystem.nodesController.get("selectionIsInspectable")){this.setUpInspectorPane()}else{this.tearDownInspectorPane();this.gotoState("DIAGRAM_EDITING")}return YES},addNode:function(a){this.gotoState("DIAGRAM_EDITING");MySystem.statechart.sendEvent("addNode",a);return YES}});MySystem.SENTENCE_OBJECT_LINKING=SC.State.design({sentenceDiagramConnect:function(a){MySystem.storySentenceController.set("editingSentence",a.sentence);this.gotoState("SENTENCE_OBJECT_LINKING_SETUP");return YES},dimAll:function(){MySystem.nodesController.unselectAll();MySystem.canvasView.get("classNames").push("sentence-linking");var a=MySystem.store.find("MySystem.Link");a.forEach(function(b){SC.Logger.log("Dimming link %s",b.get("id"));b.set("isDimmed",YES)});return YES},updateHighlighting:function(){var b=function(d){return d.kindOf(MySystem.Link)};var a=MySystem.store.find("MySystem.Link");var c=MySystem.nodesController.get("selection").filter(b);a.forEach(function(d){if(c.indexOf(d)>-1){SC.Logger.log("Un-dimming link %s",d.get("id"));d.set("isDimmed",NO)}else{SC.Logger.log("Dimming link %s",d.get("id"));d.set("isDimmed",YES)}});return YES},diagramSelectionChanged:function(){var a=MySystem.nodesController.get("selection");var b=MySystem.storySentenceController.get("editingSentence");b.get("links").removeObjects(b.get("links"));b.get("nodes").removeObjects(b.get("nodes"));a.forEach(function(c){if(c.instanceOf(MySystem.Link)){b.get("links").pushObject(c)}else{if(c.instanceOf(MySystem.Node)){b.get("nodes").pushObject(c)}else{SC.Logger.log("Bad item type "+c)}}});this.updateHighlighting();return YES},tearDownSentenceLinkPane:function(){var a=MySystem.getPath("mainPage.sentenceLinkPane");if(a.isPaneAttached){a.remove()}MySystem.nodesController.unselectAll()},closeButton:function(){SC.Logger.log("Got the closeButton event");MySystem.storySentenceController.set("editingSentence",null);this.gotoState("DIAGRAM_EDITING");return YES},enterState:function(){SC.Logger.log("Entering state %s",this.get("name"));this.updateHighlighting()},exitState:function(){SC.Logger.log("Leaving state %s",this.get("name"));var a=MySystem.store.find(MySystem.Link);this.tearDownSentenceLinkPane();a.forEach(function(b){b.set("isDimmed",NO)});if(MySystem.canvasView.get("classNames").indexOf("sentence-linking")===MySystem.canvasView.get("classNames").get("length")-1){MySystem.canvasView.get("classNames").pop()}else{if(MySystem.canvasView.get("classNames").indexOf("sentence-linking")>-1){MySystem.canvasView.get("classNames").splice(MySystem.canvasView.get("classNames").indexOf("sentence-linking"))}}}});MySystem.SENTENCE_OBJECT_LINKING_SETUP=SC.State.design({diagramSelectionChanged:function(){return YES},dimAll:function(){MySystem.nodesController.unselectAll();if(MySystem.canvasView.get("classNames").indexOf("sentence-linking")<0){MySystem.canvasView.get("classNames").push("sentence-linking")}var a=MySystem.store.find("MySystem.Link");a.forEach(function(b){b.set("isDimmed",YES)});return YES},setUpSentenceLinkPane:function(c){var b=MySystem.getPath("mainPage.sentenceLinkPane");if(c===null){c=MySystem.storySentenceController.get("editingSentence")}SC.Logger.log("Now editing linked nodes and links for %s",c.get("id"));var a=c.get("links");if(!b.isPaneAttached){b.append();b.becomeFirstResponder()}MySystem.canvasView.selectObjects(a,true);MySystem.nodesController.selectObjects(c.get("nodes"),true)},enterState:function(){SC.Logger.log("Entering state %s",this.get("name"));var a=MySystem.storySentenceController.get("editingSentence");this.dimAll();this.setUpSentenceLinkPane(a);this.gotoState("SENTENCE_OBJECT_LINKING")},exitState:function(){SC.Logger.log("Leaving state %s",this.get("name"))}});MySystem.ADDING_LINK=SC.State.design({enterState:function(){SC.Logger.log("Entering state %s",this.get("name"));this._newLink=null},_newLink:null,exitState:function(){SC.Logger.log("Leaving state %s",this.get("name"));MySystem.nodesController.deselectObject(this._newLink);this.tearDownInspectorPane()},rubberbandLinkAbandoned:function(){this.gotoState("DIAGRAM_EDITING")},rubberbandLinkComplete:function(){var d=MySystem.nodesController.get("dragLinkSrcTerminal").get("parentView"),c=MySystem.nodesController.get("dragLinkEndTerminal").get("parentView"),b=d.get("content"),a=c.get("content");var f=d.get("terminalA")===MySystem.nodesController.get("dragLinkSrcTerminal")?"a":"b";var e=c.get("terminalA")===MySystem.nodesController.get("dragLinkEndTerminal")?"a":"b";this.addLink(b,a,f,e)},addLink:function(b,a,e,d){this._newLink=MySystem.store.createRecord(MySystem.Link,{color:"#0000FF",startTerminal:e,endTerminal:d});this._newLink.addObserver("energyType",this,"_energyTypeChanged");b.addInLink(this._newLink);a.addOutLink(this._newLink);MySystem.nodesController.selectObject(this._newLink);var c=MySystem.activityController.get("energyTypes");if(c.length()>1){this.setUpInspectorPane()}else{if(c.length()===1){this._newLink.set("energyType",c.firstObject().get("uuid"))}else{this.gotoState("DIAGRAM_EDITING")}}},setUpInspectorPane:function(){var a=MySystem.getPath("mainPage.inspectorPane");a.set("isOptionsForNewLink",YES);a.set("isModal",YES);if(!a.isPaneAttached){a.append()}},_energyTypeChanged:function(){this._newLink.removeObserver("energyType",this,"_energyTypeChanged");this.gotoState("DIAGRAM_OBJECT_EDITING")},tearDownInspectorPane:function(){var a=MySystem.getPath("mainPage.inspectorPane");if(a.isPaneAttached){a.remove()}}});sc_require("states/diagram_editing");sc_require("states/diagram_object_editing");sc_require("states/sentence_object_linking");sc_require("states/sentence_object_linking_setup");sc_require("states/adding_link");MySystem.statechart=SC.Object.create(SC.StatechartManager,{rootState:SC.State.design({initialSubstate:"DIAGRAM_EDITING",DIAGRAM_EDITING:SC.State.plugin("MySystem.DIAGRAM_EDITING"),DIAGRAM_OBJECT_EDITING:SC.State.plugin("MySystem.DIAGRAM_OBJECT_EDITING"),SENTENCE_EDITING:SC.State.design({commitEdits:function(){this.gotoState("DIAGRAM_EDITING")},enterState:function(){SC.Logger.log("Entering state %s",this.get("name"))},exitState:function(){SC.Logger.log("Leaving state %s",this.get("name"))}}),ADDING_LINK:SC.State.plugin("MySystem.ADDING_LINK"),SENTENCE_OBJECT_LINKING_SETUP:SC.State.plugin("MySystem.SENTENCE_OBJECT_LINKING_SETUP"),SENTENCE_OBJECT_LINKING:SC.State.plugin("MySystem.SENTENCE_OBJECT_LINKING"),clearCanvas:function(){SC.AlertPane.warn({description:"Are you sure you want to clear your diagram?",delegate:{alertPaneDidDismiss:function(b,a){if(a===SC.BUTTON2_STATUS){MySystem.clearCanvas()}}},buttons:[{title:"Cancel"},{title:"Yes"}]})},saveButtonPressed:function(){MySystem.savingController.save()},checkButtonPressed:function(){MySystem.nodesController.focusMainPane();MySystem.activityController.checkButtonPressed()},helpButtonPressed:function(){MySystem.nodesController.focusMainPane();MySystem.storyController.showInstructions()},keyDown:function(a){if(a.keyCode===8){var b=MySystem.canvasView;if(!!b){b.keyDown(a)}return YES}else{return NO}},deleteDiagramObject:function(a,b){MySystem.nodesController.deleteObject(b);return YES},deleteDiagramSelection:function(){MySystem.nodesController.deleteSelectedObjects();return YES}})});MySystem.ExceptionHandler={handleException:function(a){if(this.isShowingErrorDialog){return}this._displayErrorDialog(a)},_displayErrorDialog:function(b){var a=this._errorDialogHTMLForException(b),c=document.createElement("div");c.style.cssText="left: 0px; right: 0px; top: 0px; bottom: 0px; position: absolute; background-color: white; background-color: rgba(255,255,255,0.6); z-index:100;";c.innerHTML=a;document.body.appendChild(c);this.isShowingErrorDialog=YES},_errorDialogHTMLForException:function(b){var a;a=['<div id="sc-error-dialog" style="position: absolute; width: 500px; left: 50%; top: 50%; margin-left: -250px; background-color: white; border: 1px solid black; font-family: Monaco, monospace; font-size: 9px; letter-spacing: 1px; padding: 10px">',"An error has occurred which prevents the application from running:","<br><br>",b.message,'<div id="sc-error-dialog-reload-button" onclick="window.location.reload();" style="float: right; font-family: Monaco, monospace; font-size: 9px; letter-spacing: 1px; border: 1px solid black; padding: 3px; clear: both; margin-top: 20px; cursor: pointer;">',"Reload","</div>","</div>"];return a.join("")},isShowingErrorDialog:NO};sc_require("core");MySystem.BadgeButtonView=SC.View.extend({layout:{top:0,left:0,width:100,height:120},classNames:"".w(),displayProperties:"content isSelected".w(),content:null,isSelected:false,childViews:"icon".w(),render:function(a){arguments.callee.base.apply(this,arguments);if(this.get("isSelected")){a.addClass("selected")}},icon:SC.ImageView.design({classNames:"image",useImageQueue:YES,layout:{top:20,width:68,height:68,centerX:0},value:"/static/my_system/en/7379d7dd5b6773f5b6b3ebb151f7d6819551bbcc/source/resources/badge.png"}),mouseDown:function(d){var e=MySystem.getPath("mainPage.mainPane.childViews").objectAt(0).getPath("bottomRightView.bottomRightView");var g=e.get("childViews");var a=g.get("length");for(var c=0;c<a;c+=1){SC.Drag.addDropTarget(g.objectAt(c))}var b=this;var f={event:d,source:b.get("parentView"),dragView:b,ghost:NO,slideBack:NO,data:{Boolean:true}};SC.Drag.start(f)},mouseUp:function(b){var d=MySystem.getPath("mainPage.mainPane.childViews").objectAt(0).getPath("bottomRightView.bottomRightView");var e=d.get("childViews");var a=e.get("length");for(var c=0;c<a;c+=1){SC.Drag.removeDropTarget(e.objectAt(c))}}});sc_require("mixins/arrow_drawing");sc_require("controllers/terminal");MySystem.TerminalView=RaphaelViews.RaphaelView.extend({childViews:"inProgressLinkView".w(),canvasView:SC.outlet("parentView.parentView.parentView"),displayProperties:"x y r isHovering radius dragLinkSrcTerminal dragLinkEndTerminal stroke".w(),x:0,y:0,radius:12,r:function(){return this.get("isHovering")?this.get("radius")*1.25:this.get("radius")}.property("isHovering, radius"),normalFill:"#ccc",hoverFill:"#00F",draggingFill:"#0F0",fillOpacity:0.4,stroke:"#333",strokeWidth:"1",strokeOpacity:"0.2",isLineDrag:NO,dragX:null,dragY:null,_raphaelCircle:null,dragLinkSrcTerminalBinding:"MySystem.nodesController.dragLinkSrcTerminal",dragLinkEndTerminalBinding:"MySystem.nodesController.dragLinkEndTerminal",isHovering:NO,fill:function(){var b=this.get("isHovering"),a=this.get("dragLinkSrcTerminal")==this,c=this.get("dragLinkEndTerminal")==this;if(b){return c?this.get("draggingFill"):this.get("hoverFill")}return a?this.get("hoverFill"):this.get("normalFill")}.property("isHovering","dragLinkSrcTerminal","dragLinkEndTerminal"),attrs:function(){return{cx:this.get("x"),cy:this.get("y"),r:this.get("r"),fill:this.get("fill"),"fill-opacity":this.get("fillOpacity"),stroke:this.get("stroke"),strokeWidth:this.get("strokeWidth"),"stroke-opacity":this.get("strokeOpacity")}},renderCallback:function(b,a){this._raphaelCircle=b.circle();this._raphaelCircle.attr(this.attrs());return this._raphaelCircle},render:function(a,b){if(b){a.callback(this,this.renderCallback,this.attrs());this.renderChildViews(a,b)}else{this._raphaelCircle.attr(this.attrs())}},mouseDown:function(a){MySystem.statechart.gotoState("ADDING_LINK");this._xTransform=this.get("canvasView").$().offset().left;this._yTransform=this.get("canvasView").$().offset().top;this.set("dragX",this.get("x"));this.set("dragY",this.get("y"));this.set("isLineDrag",YES);MySystem.terminalController.dragStart(this);return YES},touchStart:function(a){return this.mouseDown(a)},mouseDragged:function(a){return this._drag(a)},touchesDragged:function(a){var c=this.getPath("pane.rootResponder"),d=document.elementFromPoint(a.pageX,a.pageY),b=SC.$(d).view()[0];if(this._lastEnteredView&&this._lastEnteredView!=b){this._lastEnteredView.tryToPerform("mouseExited",a)}b.tryToPerform("mouseEntered",a);this._lastEnteredView=b;return this.mouseDragged(a)},_drag:function(a){if(!this.get("isLineDrag")){return NO}this.set("dragX",a.pageX-this._xTransform);this.set("dragY",a.pageY-this._yTransform);return YES},mouseUp:function(a){this._drag(a);this.set("isLineDrag",NO);MySystem.terminalController.dragComplete();return YES},touchEnd:function(a){this.mouseUp(a)},mouseEntered:function(a){MySystem.terminalController.focusIn(this);return YES},mouseExited:function(a){MySystem.terminalController.focusOut(this);return YES},inProgressLinkView:RaphaelViews.RaphaelView.design({displayProperties:"startX startY endX endY isVisible".w(),startXBinding:".parentView.x",startYBinding:".parentView.y",endXBinding:".parentView.dragX",endYBinding:".parentView.dragY",isVisibleBinding:".parentView.isLineDrag",strokeWidth:3,strokeColor:"#0000FF",_arrowPath:null,_arrowHead:null,path:function(){var d=this.get("startX"),c=this.get("endX"),b=d>c?10:-10,g=this.get("startY"),e=this.get("endY")-10,a=g>e?10:-10,f=this.get("parentView")==this.getPath("parentView.parentView.terminalA");e=e<g?e+20:e+3;c=c>d?c-3:c+3;return MySystem.ArrowDrawing.arrowPath(d,g,c,e,f,f,null,null,null,0)},attrs:function(){var a=this.path();return{tail:{path:a.tail,stroke:this.get("strokeColor"),"stroke-width":this.get("strokeWidth")},head:{path:a.head,stroke:this.get("strokeColor"),fill:this.get("strokeColor"),"stroke-width":this.get("strokeWidth")}}},_raphaelCanvas:null,renderCallback:function(c,a){var b;this._raphaelCanvas=c;this._arrowPath=c.path();this._arrowPath.attr(a.tail);this._arrowPath.node.style["pointer-events"]="none";this._arrowHead=c.path();this._arrowHead.attr(a.head);this._arrowHead.node.style["pointer-events"]="none";b=c.set();b.push(this._arrowPath,this._arrowHead);return b},render:function(b,c){if(c){b.callback(this,this.renderCallback,this.attrs());this.renderChildViews(b,c)}else{var a=this.attrs();this._arrowPath.attr(a.tail);this._arrowPath.node.style["pointer-events"]="none";this._arrowHead.attr(a.head);this._arrowHead.node.style["pointer-events"]="none"}}})});sc_require("views/terminal");MySystem.Link.reopen({diagramExampleView:function(){return MySystem.LinkView}.property()});MySystem.Node.reopen({diagramExampleView:function(){return MySystem.NodeView}.property()});MySystem.DiagramView=RaphaelViews.RaphaelCollectionView.extend({contentExampleViewKey:"diagramExampleView",allowDeselectAll:YES,acceptsFirstResponder:YES,canDeleteContent:YES,_isDragging:NO,isDropTarget:YES,dragStarted:function(b,a){},dragEntered:function(b,a){},dragUpdated:function(b,a){},dragExited:function(b,a){},dragEnded:function(b,a){},acceptDragOperation:function(a,b){return YES},computeDragOperations:function(){return SC.DRAG_LINK},performDragOperation:function(c,f){var a=this.get("canvasView").$().offset(),e=c.location.x-c.ghostOffset.x-a.left+MySystem.NodeView.DROP_OFFSET.x,d=c.location.y-c.ghostOffset.y-a.top+MySystem.NodeView.DROP_OFFSET.y,b={title:c.data.title,image:c.data.image,x:e,y:d,nodeType:c.data.uuid};MySystem.statechart.sendEvent("addNode",b);return SC.DRAG_COPY},mouseDown:function(a){if(!!a.shiftKey){a.shiftKey=NO;a.ctrlKey=YES}var b=arguments.callee.base.apply(this,arguments);if(b){this._dragX=a.pageX;this._dragY=a.pageY;this.invokeLast(this._startDrag)}return b},touchStart:function(a){return this.mouseDown(a)},mouseDragged:function(a){this._drag(a);return arguments.callee.base.apply(this,arguments)},touchesDragged:function(a,b){this.mouseDragged(a)},mouseUp:function(a){this._drag(a);this._isDragging=NO;this._dragMap=[];this._draggedViews=[];return arguments.callee.base.apply(this,arguments)},touchEnd:function(a){return this.mouseUp(a)},_startDrag:function(){var a=this.get("containerView")||this,b=this.get("canvasView").$();this._isDragging=YES;this._dragFrame={left:0,top:0,right:b.innerWidth(),bottom:b.innerHeight()};this._draggedViews=a.get("childViews").filter(function(c){return c.get("isSelected")&&c.get("content").kindOf(MySystem.Node)});this._dragMap=this._draggedViews.map(function(c){return{x:c.get("x"),y:c.get("y"),width:c.get("bodyWidth")+c.get("borderWidth")/2,height:c.get("bodyHeight")+c.get("borderWidth")/2}})},_drag:function(b){var c=b.pageX-this._dragX,a=b.pageY-this._dragY;if(!this._isDragging){return NO}if(Math.abs(c)>5||Math.abs(a)>5){this.mouseDownInfo.shouldReselect=NO;this.mouseDownInfo.shouldSelect=NO}this._dragX=b.pageX;this._dragY=b.pageY;this._updateDragMap(c,a);this._adjustDraggedViews()},_updateDragMap:function(b,a){for(var c=0;c<this._dragMap.length;c++){this._dragMap[c].x+=b;this._dragMap[c].y+=a}},_adjustDraggedViews:function(){var d,b,f,c,e,a;for(d=0;d<this._draggedViews.length;d++){b=this._dragMap[d].x;f=this._dragMap[d].y;e=this._dragMap[d].width;a=this._dragMap[d].height;if(b<this._dragFrame.left){b=this._dragFrame.left}if(b+e>this._dragFrame.right){b=this._dragFrame.right-e}if(f<this._dragFrame.top){f=this._dragFrame.top}if(f+a>this._dragFrame.bottom){f=this._dragFrame.bottom-a}c=this._draggedViews[d];c.beginPropertyChanges();c.set("x",b);c.set("y",f);c.endPropertyChanges()}}});MySystem.DiagramBackgroundView=RaphaelViews.RaphaelView.extend(SC.ContentDisplay,{displayProperties:"imageDidLoad imageUrl width height".w(),imageUrl:null,imageDidLoad:false,scalingEnabled:false,_raphaelImage:null,width:0,height:0,x:0,y:0,reloadImage:function(){this._reloadImage()}.observes("imageUrl"),changeScale:function(){this._reloadImage()}.observes("scalingEnabled"),_reloadImage:function(){this.set("imageDidLoad",false);image=new Image();this.set("width",0);this.set("height",0);this.set("isVisibile",false);var a=this;image.onload=function(){a.setImageDimensions(image);a.set("isVisibile",true)};image.src=this.get("imageUrl")},renderCallback:function(b,a){this._raphaelImage=b.image();this._raphaelImage.attr(a);return b.set().push(this._raphaelImage)},render:function(c,e){var b={x:this.get("x"),y:this.get("y"),width:this.get("width"),height:this.get("height")};var a=this.get("imageUrl");if(typeof a==="string"){var d=a.replace(/\s+/,"");if(d.length>0){b.src=a}}if(e){this._reloadImage();c.callback(this,this.renderCallback,b);this.renderChildViews(c,e)}else{this._raphaelImage.attr(b)}},parentViewDidResize:function(){this._reloadImage()},setImageDimensions:function(f){if(f.width>1){var d=this.parentView.clippingFrame().width;var a=this.parentView.clippingFrame().height;var e=d/f.width;var c=a/f.height;var b=e>c?c:e;b=(this.get("scalingEnabled")===true)?b:1;SC.RunLoop.begin();this.set("width",f.width*b);this.set("height",f.height*b);this.set("imageDidLoad",true);f.onload=null;SC.RunLoop.end()}}});MySystem.EditableLabelView=RaphaelViews.RaphaelView.extend(SC.Editable,{childViews:["editBoxView"],displayProperties:"displayText textColor centerX centerY fontSize".w(),isEditing:NO,isAllSelected:NO,fontSize:12,text:"",textColor:"#000",centerX:0,centerY:0,displayText:function(){var a=this.get("text");if(this.get("isEditing")){a=a+"_"}else{a=(a.replace(/\s+/g,"")==="")?"«click to edit»":a}return a}.property("text","isEditing").cacheable(),textBBox:function(){var a=this.get("raphaelObject");return a?a.getBBox():null}.property("displayText","centerX","centerY","fontSize","raphaelObject"),acceptsFirstResponder:function(){return this.get("isEnabled")}.property("isEnabled").cacheable(),willLoseFirstResponder:function(){this.set("isEditing",NO);this.set("isAllSelected",NO)},renderCallback:function(b,a){return b.text().attr(a)},render:function(b,d){var a={x:this.get("centerX"),y:this.get("centerY"),fill:this.get("textColor"),text:this.get("displayText"),"font-size":this.get("fontSize"),"text-anchor":"middle"},c;if(d){b.callback(this,this.renderCallback,a);this.renderChildViews(b,d)}else{c=this.get("raphaelObject");c.attr(a)}},toggle:function(a){this.set(a,(!this.get(a)))},editFirstTime:function(){var a=this.get("item");if(this.get("isEditFirstTimePending")){this.beginEditing();this.beginEditing()}}.observes("isEditFirstTimePending"),beginEditing:function(){if(!this.get("isEditable")){return NO}this.becomeFirstResponder();if(this.get("isEditing")){this.toggle("isAllSelected")}else{this.set("isEditing",YES)}return YES},discardEditing:function(){return this.commitEditing()},commitEditing:function(){this.resignFirstResponder();this.set("isEditing",NO);return YES},updateText:function(a){this.beginPropertyChanges();this.set("isAllSelected",NO);this.set("text",a);this.endPropertyChanges()},keyDown:function(a){var b=null;if(this.interpretKeyEvents(a)){return YES}if(a.type==="keypress"){b=a.getCharString();if(b){this.appendText(b);return YES}}return NO},appendText:function(a){if(this.get("isAllSelected")){this.updateText(a)}else{this.updateText(this.get("text")+a)}return YES},insertNewline:function(){this.commitEditing()},insertTab:function(){this.commitEditing()},cancel:function(){this.discardEditing()},selectAll:function(){this.set("isAllSelected",YES)},deleteBackward:function(){var a=this.get("text"),b=a.substr(0,a.length-1);if(this.get("isAllSelected")){b=""}this.updateText(b);return YES},recentUp:function(a){var d=new Date().getTime(),b=202,c=200;if(typeof this.lastUp!=="undefined"&&this.lastUp){b=d-this.lastUp;if(b<c){return YES}}if(a){this.lastUp=d}return NO},mouseDown:function(a){if(!this.get("isEditable")){return NO}if(this.recentUp(NO)){return YES}return YES},mouseUp:function(a){if(!this.get("isEditable")){return NO}if(this.recentUp(YES)){return this.doubleClick(a)}return NO},doubleClick:function(a){if(!this.get("isEditable")){return NO}this.beginEditing();return YES},editBoxView:RaphaelViews.RaphaelView.design({displayProperties:"textBBox isAllSelected".w(),textLabelView:SC.outlet("parentView"),isVisibleBinding:".textLabelView.isEditing",isAllSelectedBinding:".textLabelView.isAllSelected",textBBoxBinding:".textLabelView.textBBox",textBBoxBindingDefault:SC.Binding.oneWay(),minHeight:18,minWidth:20,margin:2,fill:"#FF5",strokeWidth:1,stroke:"#CCC",editingOpacity:0.3,normalOpacity:0.05,x:function(){var a=this.get("textBBox");return a?a.x-this.get("margin"):0}.property("textBBox").cacheable(),y:function(){var a=this.get("textBBox");return a?a.y-this.get("margin"):0}.property("textBBox").cacheable(),width:function(){var c=this.get("textBBox"),b=this.get("minWidth"),a=c?c.width+2*this.get("margin"):0;return(a>=b)?a:b}.property("textBBox").cacheable(),height:function(){var c=this.get("textBBox"),b=this.get("minHeight"),a=c?c.height+2*this.get("margin"):0;return(a>=b)?a:b}.property("textBBox").cacheable(),renderCallback:function(b,a){return b.rect().attr(a)},render:function(d,e){var c,b=this.get("isAllSelected")?this.get("editingOpacity"):this.get("normalOpacity"),a={fill:this.get("fill"),"fill-opacity":b,"stroke-width":this.get("strokeWidth"),stroke:this.get("stroke"),x:this.get("x"),y:this.get("y"),width:this.get("width"),height:this.get("height")};if(e){d.callback(this,this.renderCallback,a)}else{c=this.get("raphaelObject");c.attr(a)}}})});MySystem.LinkFormView=SC.FormView.extend({layout:{top:0,minHeight:100,left:0,right:0},linkSelectionOnly:NO,contentBinding:SC.Binding.oneWay("MySystem.nodesController.selection").firstIfType(MySystem.Link),childViews:"energy label description".w(),isVisible:NO,contentChanged:function(){var a=this.get("content");if(!!a&&a.instanceOf(MySystem.Link)){this.set("isVisible",YES)}else{this.set("isVisible",NO)}}.observes("*content.guid"),energy:SC.FormView.row("Energy:",SC.RadioView.design({layout:{width:"180",height:700},classNames:["border"],itemsBinding:SC.Binding.oneWay("MySystem.activityController.energyTypes"),contentValueKey:"energyType",itemTitleKey:"label",itemValueKey:"uuid",itemIsEnabledKey:"isEnabled",layoutDirection:SC.LAYOUT_VERTICAL,adjustHeight:function(){var a=this.getPath("items.length")*24;this.adjust("height",a)}.observes("items"),displayItems:function(){var a=arguments.callee.base.apply(this,arguments);for(var b=0;b<a.length;b++){var c=this._findItemByValue(a[b].get("value"));if(!!c){a[b].set("color",c.get("color"))}}return a}.property("isEnabled","value","items","itemTitleKey","itemWidthKey","itemValueKey","itemIsEnabledKey","localize","itemIconKey","itemAriaLabeledByKey","itemAriaLabelKey").cacheable(),_findItemByValue:function(f){var c=this.get("itemValueKey");var a=this.get("items");for(var b=0;b<a.length();b++){var d=a.objectAt(b);var e=d.get(c);if(e==f){return d}}return null}})),label:SC.FormView.row("Label:",SC.TextFieldView.design({layout:{width:"250",height:20,centerY:0},contentValueKey:"text",isEditableBinding:SC.Binding.oneWay("MySystem.activityController.enableLinkLabelEditing"),linkSelectionOnlyBinding:SC.Binding.oneWay(".parentView.linkSelectionOnly"),isVisible:function(){var b=this.getPath(".parentView.linkSelectionOnly");var a=this.get("isEditable");return(a&&(!b))}.property("isEditable",".parentView.linkSelectionOnly")})),description:SC.FormView.row("Description:",SC.TextFieldView.design({layout:{width:250,height:60,centerY:0},isEditableBinding:SC.Binding.oneWay("MySystem.activityController.enableLinkDescriptionEditing"),linkSelectionOnlyBinding:SC.Binding.oneWay(".parentView.linkSelectionOnly"),contentValueKey:"description",isTextArea:YES,isVisible:function(){var b=this.getPath(".parentView.linkSelectionOnly");var a=this.get("isEditable");return(a&&(!b))}.property("isEditable",".parentView.linkSelectionOnly")}))});MySystem.NodeFormView=SC.FormView.extend({layout:{top:0,bottom:0,left:0,right:0},contentBinding:SC.Binding.oneWay("MySystem.nodesController.selection").firstIfType(MySystem.Node),childViews:"title description".w(),isVisible:NO,contentChanged:function(){var a=this.get("content");if(!!a&&a.instanceOf(MySystem.Node)){this.set("isVisible",YES)}else{this.set("isVisible",NO)}}.observes("*content.guid"),title:SC.FormView.row("Title:",SC.TextFieldView.design({layout:{width:150,height:20},isVisibleBinding:SC.Binding.oneWay("MySystem.activityController.enableNodeLabelEditing"),contentValueKey:"title"})),description:SC.FormView.row("Description:",SC.TextFieldView.design({layout:{width:150,height:60,centerY:0},isVisibleBinding:SC.Binding.oneWay("MySystem.activityController.enableNodeDescriptionEditing"),contentValueKey:"description",isTextArea:YES}))});sc_require("core");sc_require("views/link_form");sc_require("views/node_form");MySystem.InspectorPane=SC.PalettePane.design({defaultResponder:"MySystem.statechart",isOptionsForNewLink:NO,layout:{top:150,right:5,width:400,height:200},classNames:"property-editor".w(),contentView:SC.View.design({childViews:"title linkForm nodeForm".w(),title:SC.LabelView.design({value:"Pick an energy type for your new link",isVisibleBinding:".parentView.parentView.isOptionsForNewLink",layout:{top:0,left:0,right:0,height:22}}),linkForm:SC.ScrollView.design({layout:{top:22,left:0,right:0},contentView:MySystem.LinkFormView.design({linkSelectionOnlyBinding:".parentView.parentView.isOptionsForNewLink"})}),nodeForm:MySystem.NodeFormView.design({layout:{top:22,left:0,right:0}}),})});sc_require("core");MySystem.SubmissionsFeedbackLabel=SC.View.extend({displayProperties:["value"],classNames:"sumbissions_feedback_label".w(),click:function(a){MySystem.activityController.showFeedbackPalette()},render:function(a){a.push("<div id='sumbission_feedback_label'>",this.get("value"),"</div>")},update:function(a){a.find("#sumbission_feedback_label").text(this.get("value"))}});require("views/sumbissions_feedback_label");MySystem.InstructionView=SC.View.extend({childViews:"helpButtonView clearButtonView numSubmissions checkButtonView saveButtonView saveStatusView ".w(),backgroundColor:"#eeefff",canCollapse:YES,helpButtonView:SC.ButtonView.design({layout:{left:5,top:5,height:25,width:145},title:"Show instructions",toolTip:"Show instructions",icon:"sc-icon-info-16",action:"helpButtonPressed"}),checkButtonView:SC.ButtonView.design({layout:{left:155,top:5,height:25,width:135},title:"Submit Diagram",toolTip:"Submit your diagram",icon:"sc-icon-bookmark-16",isEnabledBinding:"MySystem.activityController.canSubmit",action:"checkButtonPressed"}),numSubmissions:MySystem.SubmissionsFeedbackLabel.design({layout:{left:5,top:35,height:20,width:220},value:"test",textAlign:SC.ALIGN_LEFT,valueBinding:"MySystem.activityController.submissionInfo",visible:YES}),clearButtonView:SC.ButtonView.design({layout:{left:350,top:5,height:25,width:80},title:"Clear",icon:"sc-icon-trash-16",toolTip:"Clear everything from your diagram",action:"clearCanvas"}),saveButtonView:SC.ButtonView.design({layout:{left:440,top:5,height:25,width:80},title:"Save",isEnabledBinding:"MySystem.savingController.enableManualSave",toolTip:"Save your diagram",icon:"sc-icon-folder-16",action:"saveButtonPressed"}),saveStatusView:SC.LabelView.design({layout:{left:350,top:40,height:25,width:170},textAlign:SC.ALIGN_RIGHT,displayProperties:"isDirty value".w(),valueBinding:"MySystem.savingController.saveStatusText",isDirtyBinding:"MySystem.savingController.dataIsDirty",render:function(a,b){if(!this.get("isDirty")){a.addClass("save_clean_class")}else{a.addClass("save_dirty_class")}return arguments.callee.base.apply(this,arguments)}})});sc_require("core");MySystem.InstructionPallet=SC.PalettePane.extend({layout:{width:600,height:400,centerX:0,centerY:0},error:false,isModal:true,isAnchored:true,contentView:SC.View.extend({classNames:"instruction_palette".w(),render:function(a){a.push('<div class="instruction_content">',this.get("instructions"),"</div>");arguments.callee.base.apply(this,arguments)},update:function(a){a.find(".instruction_content").html(this.get("instructions"))}}).design({layout:{width:600,height:400,right:0,top:0},displayProperties:"instructions instructionPanelWidth instructionPanelHeight".w(),instructionsBinding:"MySystem.storyController.content",instructionPanelWidthBinding:"MySystem.storyController.instructionPanelWidth",feedbackPanelHeightBinding:"MySystem.storyController.instructionPanelHeight",adjustSize:function(){var a=this.get("parentView"),c=this.get("instructionPanelWidth"),b=this.get("instructionPanelHeight");a.adjust("width",c);a.adjust("height",b);this.adjust("width",c);this.adjust("height",b)}.observes("instructionPanelWidth","instructionPanelHeight"),childViews:"closeButton".w(),closeButton:SC.ButtonView.design({layout:{width:100,height:30,centerX:0,bottom:10},title:"close",action:"MySystem.storyController.hideInstructions"})})});MySystem.LetterboxImageView=SC.ImageView.extend({useImageQueue:NO,didLoad:function(a){arguments.callee.base.apply(this,arguments);this.adjustLetterBox()},adjustLetterBox:function(){var j=0;var e=0;var c=0;var f=0;var d=0;var a=0;var h=0;var g=0;var b=this.get("image");j=this.clippingFrame().width-2;e=this.clippingFrame().height-2;j=(j<2)?2:j;e=(e<2)?2:e;c=j/b.width;f=e/b.height;ratio=c>f?f:c;d=b.width*ratio;a=b.height*ratio;h=(j-d)/2+1;g=(e-a)/2;this.adjust({centerX:0,centerY:0,width:d,height:a})}});MySystem.RemoveButtonView=RaphaelViews.RaphaelView.extend({displayProperties:"r cx cy circleStrokeWidth xStrokeWidth xDisplacement circleStroke circleFill xStroke".w(),isHovered:NO,r:12,cx:0,cy:0,circleStrokeWidth:3,xStrokeWidth:3,hoveredXDisplacement:6,normalXDisplacement:5,normalCircleStroke:"#CCC",hoveredCircleStroke:"#666",normalCircleFill:"#FFF",hoveredCircleFill:"#666",normalXStroke:"#CCC",hoveredXStroke:"#FFF",xDisplacement:function(){return this.get("isHovered")?this.get("hoveredXDisplacement"):this.get("normalXDisplacement")}.property("isHovered"),circleStroke:function(){return this.get("isHovered")?this.get("hoveredCircleStroke"):this.get("normalCircleStroke")}.property("isHovered","normalCircleStroke","hoveredCircleStroke"),circleFill:function(){return this.get("isHovered")?this.get("hoveredCircleFill"):this.get("normalCircleFill")}.property("isHovered","normalCircleFill","hoveredCircleFill"),xStroke:function(){return this.get("isHovered")?this.get("hoveredXStroke"):this.get("normalXStroke")}.property("isHovered","normalXStroke","hoveredXStroke"),renderCallback:function(c,b,a){return c.set().push(c.circle().attr(b),c.path().attr(a))},render:function(b,a){var f=this.get("cx")||0,e=this.get("cy")||0,l={cx:f,cy:e,r:this.get("r"),stroke:this.get("circleStroke"),fill:this.get("circleFill"),"stroke-width":this.get("circleStrokeWidth")},h=this.get("xDisplacement"),m=["M",f-h,e-h,"L",f+h,e+h,"M",f-h,e+h,"L",f+h,e-h].join(" "),g={path:m,stroke:this.get("xStroke"),"stroke-width":this.get("xStrokeWidth")},j,c,k;if(a){b.callback(this,this.renderCallback,l,g)}else{j=this.get("raphaelObject");c=j.items[0];k=j.items[1];c.attr(l);k.attr(g)}},mouseEntered:function(){this.set("isHovered",YES);return YES},mouseExited:function(){this.set("isHovered",NO);return YES},mouseDown:function(){return this.get("parentView").removeButtonClicked()}});sc_require("views/editable_label");sc_require("views/terminal");sc_require("views/remove_button");sc_require("mixins/arrow_drawing");MySystem.LinkView=RaphaelViews.RaphaelView.extend(SC.ContentDisplay,{nodeWidthBinding:SC.Binding.oneWay("MySystem.activityController.content.nodeWidth"),nodeHeightBinding:SC.Binding.oneWay("MySystem.activityController.content.nodeHeight"),displayProperties:"content.endNode.x content.endNode.y content.startNode.x content.startNode.y lineColor borderColor borderOpacity lineWidth borderWidth".w(),childViews:"removeButtonView".w(),lineColorBinding:"*content.color",borderColor:"#ADD8E6",borderOpacity:function(){return this.get("isSelected")?1:0}.property("isSelected"),lineWidth:6,borderWidth:4,isHovered:NO,showRemoveButtonForHover:NO,unhoverInterval:500,_unhoverTimer:null,isHoveredDidChange:function(){if(this._unhoverTimer){this._unhoverTimer.invalidate()}if(this.get("isHovered")){this.set("showRemoveButtonForHover",YES)}else{this._unhoverTimer=SC.Timer.schedule({target:this,action:"unhoverTimeout",interval:this.get("unhoverInterval")})}}.observes("isHovered"),unhoverTimeout:function(){this.set("showRemoveButtonForHover",NO)},diagramControllerBinding:"MySystem.nodesController",onlySelectedDiagramObjectBinding:"*diagramController.onlySelectedObject",isOnlySelectedDiagramObject:function(){return this.get("onlySelectedDiagramObject")===this.get("content")}.property("onlySelectedDiagramObject","content"),isRemoveButtonOccluded:NO,isRemoveButtonVisible:function(){return(this.get("showRemoveButtonForHover")||this.get("isOnlySelectedDiagramObject"))&&!this.get("isRemoveButtonOccluded")}.property("showRemoveButtonForHover","isOnlySelectedDiagramObject","isRemoveButtonOccluded"),removeButtonX:0,removeButtonY:0,removeButtonView:MySystem.RemoveButtonView.design({isVisibleBinding:".parentView.isRemoveButtonVisible",normalCircleStrokeBinding:".parentView.lineColor",normalXStrokeBinding:".parentView.lineColor",cxBinding:".parentView.removeButtonX",cyBinding:".parentView.removeButtonY"}),renderCallback:function(b,a,h,m,j){var g=b.path().attr(a),k=b.path().attr(h),c=b.path().attr(m),e=b.path().attr(j),l=b.text().attr(this._getLabelAttrs(g)),d=b.rect().attr(this._getLabelBackgroundAttrs(b,l)),f=b.set().push(c,e,g,k,d,l.toFront());this._setRemoveButtonLocation(f);return f},render:function(e,j){var t=this.get("content"),z=t.get("startNode"),o=t.get("endNode"),g=this.get("nodeHeight"),h=this.get("nodeWidth")/2,x=0,w=0,c=0,b=0;if(!!z){x=z.get("x");w=z.get("y")}if(!!o){c=o.get("x");b=o.get("y")}var q=(t.get("startTerminal")==="a"),v=(t.get("endTerminal")==="a");if(q){x=x+h;w=w}else{x=x+h;w=w+g}if(v){c=c+h;b=b}else{c=c+h;b=b+g}var r=MySystem.ArrowDrawing.arrowPath(x,w,c,b,q,v);var d=this.get("lineColor")||"#000099";var A={path:r.tail+r.head,stroke:this.get("borderColor"),opacity:this.get("borderOpacity"),"stroke-width":this.get("lineWidth")+2+2*this.get("borderWidth"),"stroke-linecap":"round"},u={path:r.tail+r.head,stroke:"#FFFFFF",opacity:this.get("borderOpacity"),"stroke-width":this.get("lineWidth")+3,"stroke-linecap":"round"},a={path:r.tail,stroke:d,"stroke-width":this.get("lineWidth"),"stroke-linecap":"round"},y={path:r.head,stroke:d,fill:d,"stroke-width":this.get("lineWidth"),"stroke-linecap":"round"},n,s,p,f,m,l,k;if(j){e.callback(this,this.renderCallback,a,y,A,u);this.renderChildViews(e,j)}else{n=this.get("raphaelObject");s=n.items[0];p=n.items[1];m=n.items[2];f=n.items[3];l=n.items[4];k=n.items[5];s.attr(A);p.attr(u);m.attr(a);f.attr(y);k.attr(this._getLabelAttrs(m));l.attr(this._getLabelBackgroundAttrs(this,k));l.toFront();k.toFront();this._setRemoveButtonLocation(n)}},_getLabelAttrs:function(b){if(b.getTotalLength()<1){return{}}var a=b.getPointAtLength(b.getTotalLength()*(2/3));var c=this.get("content").get("text");return{x:a.x,y:a.y,fill:"black",text:!!c?c:""}},_getLabelBackgroundAttrs:function(b,a){var e=a.getBBox();if(e.height===0){return{}}var c=10;var d=6;return{x:e.x-c/2,y:e.y-d/2,width:e.width+c,height:e.height+d+1,r:5,fill:"white",stroke:"#444444","stroke-width":1,"stroke-opacity":0.5}},_setRemoveButtonLocation:function(h){var o=h.items[2],a=35,n=18,d,k,j,b,m,l,g,f,c;var e=this.get("content");if(!e.isComplete()){return}if(o.attr("path").length<1){return}d=o.getTotalLength();j=o.getPointAtLength(d);if(d>50){k=o.getPointAtLength(d-a);m=j.x-k.x;l=j.y-k.y;b=n/a*(m>0?1:-1);g=k.x+b*l;f=k.y-b*m;c=NO}else{g=0;f=0;c=YES}this.set("removeButtonX",g);this.set("removeButtonY",f);this.set("isRemoveButtonOccluded",c)},mouseEntered:function(){this.set("isHovered",YES);return YES},mouseExited:function(){this.set("isHovered",NO);return YES},removeButtonClicked:function(){this.set("isVisible","false");MySystem.statechart.sendAction("deleteDiagramObject",this,this.get("content"))}});sc_require("views/editable_label");sc_require("views/terminal");sc_require("views/remove_button");MySystem.NodeView=RaphaelViews.RaphaelView.extend(SC.ContentDisplay,{childViews:"removeButtonView titleView terminalA terminalB".w(),contentDisplayProperties:"x y image title".w(),displayProperties:"bodyWidth bodyHeight bodyColor bodyOpacity borderColor borderOpacity borderWidth borderRadius imageWidth imageHeight enableNodeLabelDisplay".w(),isSelected:NO,isDragging:NO,isHovered:NO,verticalMargin:0,horizontalMargin:0,bodyWidthBinding:SC.Binding.oneWay("MySystem.activityController.content.nodeWidth"),bodyHeightBinding:SC.Binding.oneWay("MySystem.activityController.content.nodeHeight"),terminalRadiusBinding:SC.Binding.oneWay("MySystem.activityController.content.terminalRadius"),enableNodeLabelDisplayBinding:SC.Binding.oneWay("MySystem.activityController.content.enableNodeLabelDisplay"),bodyColor:"#000000",bodyOpacity:0,fontSize:14,titleBinding:"*content.title",xBinding:"*content.x",yBinding:"*content.y",centerX:function(){return this.get("x")+this.get("bodyWidth")/2}.property("x","bodyWidth").cacheable(),titleY:function(){return this.get("y")+this.get("bodyHeight")+this.get("fontSize")+this.get("terminalRadius")}.property("y","bodyHeight").cacheable(),terminalAY:function(){return this.get("y")}.property("y","bodyHeight").cacheable(),terminalBY:function(){return this.get("y")+this.get("bodyHeight")}.property("y","bodyHeight").cacheable(),borderColor:function(){return this.get("isSelected")?"rgb(173, 216, 230)":"#CCCCCC"}.property("isSelected").cacheable(),borderOpacity:1,borderWidth:function(){return this.get("isSelected")?4:1}.property("isSelected"),borderRadius:5,_raphaelImage:null,_raphaelRect:null,diagramControllerBinding:"MySystem.nodesController",onlySelectedDiagramObjectBinding:"*diagramController.onlySelectedObject",isOnlySelectedDiagramObject:function(){return this.get("onlySelectedDiagramObject")===this.get("content")}.property("onlySelectedDiagramObject","content"),isRemoveButtonVisible:function(){return this.get("isHovered")||this.get("isOnlySelectedDiagramObject")}.property("isHovered","isOnlySelectedDiagramObject"),removeButtonView:MySystem.RemoveButtonView.design({isVisibleBinding:".parentView.isRemoveButtonVisible",parentBorderColorBinding:".parentView.borderColor",parentXBinding:".parentView.x",parentBodyWidthBinding:".parentView.bodyWidth",normalCircleStrokeBinding:".parentBorderColor",hoveredCircleStroke:"#666",normalCircleFill:"#FFF",hoveredCircleFill:"#666",normalXStrokeBinding:".parentBorderColor",hoveredXStroke:"#FFF",cx:function(){return this.get("parentX")+this.get("parentBodyWidth")}.property("parentX","parentBodyWidth"),cyBinding:".parentView.y"}),titleView:MySystem.EditableLabelView.design({isEditable:NO,isVisibleBinding:".parentView.enableNodeLabelDisplay",fontSizeBinding:".parentView.fontSize",textColor:"#000",textBinding:".parentView.title",centerXBinding:".parentView.centerX",centerYBinding:".parentView.titleY",selectMe:function(){var a=this.getPath("parentView.content");MySystem.nodesController.unselectAll();MySystem.nodesController.selectObject(a)}.observes("isEditing")}),terminalA:MySystem.TerminalView.design({xBinding:".parentView.centerX",yBinding:".parentView.terminalAY",radiusBinding:SC.Binding.oneWay(".parentView.terminalRadius"),isVisible:YES}),terminalB:MySystem.TerminalView.design({xBinding:".parentView.centerX",yBinding:".parentView.terminalBY",radiusBinding:SC.Binding.oneWay(".parentView.terminalRadius"),isVisible:YES}),renderCallback:function(c,b,a){this._raphaelRect=c.rect();this._raphaelImage=c.image();this._raphaelRect.attr(b);this._raphaelImage.attr(a);return c.set().push(this._raphaelRect,this._raphaelImage)},render:function(c,a){var g=this.get("content");var b=this.get("horizontalMargin");var f=this.get("verticalMargin");if(a){var d=new Image();var j=this;d.onload=function(){j.setImageDimensions(d)};d.src=g.get("image")}var h={x:g.get("x"),y:g.get("y"),r:this.get("borderRadius"),width:this.get("bodyWidth"),height:this.get("bodyHeight"),fill:this.get("bodyColor"),"fill-opacity":this.get("bodyOpacity"),stroke:this.get("borderColor"),"stroke-width":this.get("borderWidth"),"stroke-opacity":this.get("borderOpacity")},e={src:g.get("image"),x:b+g.get("x"),y:g.get("y"),width:this.get("imageWidth")||10,height:this.get("imageHeight")||10};if(a){c.callback(this,this.renderCallback,h,e);this.renderChildViews(c,a)}else{this._raphaelRect.attr(h);this._raphaelImage.attr(e)}},setImageDimensions:function(d){d.onload=null;if(d.width>1){var m=this.get("bodyWidth"),n=this.get("bodyHeight"),l=m*0.9,j=n*0.9,e=d.width,o=d.height,k=(j/o),h=(l/e),c=h<k?h:k,g=e*c,b=o*c,a=(m-g)/2,f=(n-b)/2;SC.RunLoop.begin();this.set("imageWidth",g);this.set("imageHeight",b);this.set("horizontalMargin",a);this.set("verticalMargin",f);SC.RunLoop.end()}},mouseEntered:function(){this.set("isHovered",YES);return YES},mouseExited:function(){this.set("isHovered",NO);return YES},removeButtonClicked:function(){MySystem.statechart.sendAction("deleteDiagramObject",this,this.get("content"));return YES}});MySystem.NodeView.mixin({DROP_OFFSET:{x:21,y:16}});sc_require("core");sc_require("views/letterbox_image");MySystem.PaletteItemView=SC.View.extend({layout:{top:10,centerX:0,width:50},displayProperties:"content isSelected width height enableNodeLabelDisplay".w(),content:null,isSelected:false,widthBinding:SC.Binding.oneWay("MySystem.activityController.content.nodeWidth"),heightBinding:SC.Binding.oneWay("MySystem.activityController.content.nodeHeight"),enableNodeLabelDisplayBinding:SC.Binding.oneWay("MySystem.activityController.content.enableNodeLabelDisplay"),childViews:"borderFrame".w(),widthChanged:function(){this.adjust("width",this.get("width")+20)}.observes("width"),heightChanged:function(){this.adjust("height",this.get("height")+20)}.observes("height"),render:function(a){arguments.callee.base.apply(this,arguments);if(this.get("isSelected")){a.addClass("selected")}},borderFrame:SC.View.design({classNames:"node addbutton".w(),layout:{left:0.12,right:0.12,top:6,bottom:6},childViews:"icon label".w(),icon:MySystem.LetterboxImageView.design({classNames:["image"],useCanvas:NO,layout:{bottom:16,top:0,width:100,centerX:0},valueBinding:".parentView.parentView.content.image"}),label:SC.LabelView.design({layout:{height:14,bottom:2,left:2,right:2},classNames:["name"],textAlign:SC.ALIGN_CENTER,valueBinding:".parentView.parentView.content.title",isVisibleBinding:".parentView.parentView.enableNodeLabelDisplay",isEditable:NO})}),dragDataForType:function(b,a){return null},mouseDown:function(a){return YES},mouseDragged:function(a){this._startDrag(a)},_startDrag:function(a){var b={event:a,source:this,dragView:this,ghost:NO,slideBack:NO,data:{title:this.get("content").get("title")||"title",image:this.get("content").get("image")||"image",uuid:this.get("content").get("uuid")}};this._drag=SC.Drag.start(b)},touchStart:function(a){return YES},touchesDragged:function(a,b){if(this._drag){return}this._startDrag(a)},dragDidEnd:function(a,b,c){this._drag=null}});sc_require("core");sc_require("views/palette_item");MySystem.NodePaletteView=SC.ListView.extend({layout:{top:0,bottom:0,left:0},contentBinding:"MySystem.nodePaletteController",exampleView:MySystem.PaletteItemView,rowDelegate:MySystem.nodePaletteController});MySystem.SentenceView=SC.View.extend({childViews:"sentenceText linkButton".w(),classNames:"story-sentence",sentenceText:SC.LabelView.design({layout:{left:5,right:50},valueBinding:".parentView*content.bodyText",canEditContent:YES,canDeleteContent:YES,isEditable:YES}),linkButton:SC.ButtonView.design({layout:{right:5,width:40},titleMinWidth:45,value:NO,contentBinding:".parentView*content",buttonBehavior:SC.TOGGLE_BEHAVIOR,icon:"/static/my_system/en/7379d7dd5b6773f5b6b3ebb151f7d6819551bbcc/source/resources/icon_link.gif",toolTip:"Link this sentence with part of the diagram",pushButton:function(){if(this.value){MySystem.statechart.sendEvent("sentenceDiagramConnect",{sentence:this.content});this.set("value",NO)}}.observes("value")})});MySystem.SentenceConnectPane=SC.PalettePane.create({defaultResponder:"MySystem.statechart",layout:{top:150,right:5,width:150,height:150},classNames:"sentence-connect-pane".w(),contentView:SC.View.design({childViews:"labelView doneButton".w(),labelView:SC.LabelView.design({layout:{left:5,right:5,top:5,width:140,height:80},value:"Select the nodes and links your sentence describes, then click the 'Done' button.",canEditContent:YES,canDeleteContent:YES,isEditable:NO,isEnabled:YES}),doneButton:SC.ButtonView.design({buttonBehavior:SC.PUSH_BEHAVIOR,layout:{left:10,right:10,bottom:10,height:20},title:"Done",toolTip:"Click to link and close this window",action:"closeButton",theme:"capsule",isEnabled:YES})})});sc_require("views/sentence");MySystem.UserStoryView=SC.View.extend({childViews:"sentencesView addButtonView".w(),backgroundColor:"#eeefff",sentencesView:SC.ScrollView.design({hasHorizontalScroller:NO,layout:{top:5,right:5,bottom:30,left:5},contentView:SC.ListView.design({contentBinding:"MySystem.storySentenceController.arrangedObjects",selectionBinding:"MySystem.storySentenceController.selection",contentValueKey:"bodyText",rowHeight:20,exampleView:MySystem.SentenceView,canEditContent:YES,canDeleteContent:YES,canReorderContent:YES})}),addButtonView:SC.ButtonView.design({layout:{bottom:10,right:15,height:20,width:150},title:"Add sentence to story",target:"MySystem.storySentenceController",action:"addStorySentence",toolTip:"Add a sentence to the story"})});sc_require("views/user_story");MySystem.StoriesView=SC.SplitView.extend({layoutDirection:SC.LAYOUT_HORIZONTAL,topLeftView:MySystem.InstructionView,dividerView:SC.SplitDividerView,bottomRightView:MySystem.UserStoryView});MySystem.StoryFormView=SC.FormView.extend({contentBinding:SC.Binding.oneWay("MySystem.storyController.content"),childViews:"story".w(),story:SC.FormView.row("Story:",SC.TextFieldView.design({layout:{width:150,height:20},contentValueKey:"storyHtml"}))});sc_require("core");MySystem.SubmissionsFeedbackPallet=SC.PalettePane.extend({layout:{width:500,height:250,right:200,top:200},error:false,contentView:SC.View.extend({classNames:"feedbackpaelletcontent".w(),render:function(a){a.push('<div class="sumbission_info">',this.get("submissionInfo"),"</div>");a.push('<div class="last_feedback">',this.get("lastFeedback"),"</div>")},update:function(a){var b="";a.find(".sumbission_info").text(this.get("submissionInfo"));b=this.get("lastFeedback");if(b){a.find(".last_feedback").html(b.split("\n").join("<br/>"))}}}).design({layout:{width:500,height:250,right:0,top:0},displayProperties:"lastFeedback submissionInfo feedbackPanelWidth feedbackPanelHeight".w(),lastFeedback:"no Feedback yet",lastFeedbackBinding:"MySystem.activityController.lastFeedback",submissionInfoBinding:"MySystem.activityController.submissionInfo",feedbackPanelWidthBinding:"MySystem.activityController.feedbackPanelWidth",feedbackPanelHeightBinding:"MySystem.activityController.feedbackPanelHeight",adjustSize:function(){var b=this.get("parentView"),c=this.get("feedbackPanelWidth"),a=this.get("feedbackPanelHeight");b.adjust("width",c);b.adjust("height",a);this.adjust("width",c);this.adjust("height",a)}.observes("feedbackPanelWidth","feedbackPanelHeight"),childViews:"closeButton".w(),closeButton:SC.ButtonView.design({layout:{width:100,height:30,centerX:0,bottom:10},title:"close",action:"MySystem.activityController.hideFeedbackPalette"})})});sc_require("views/node_palette");MySystem.mainPage=SC.Page.design({mainPane:SC.MainPane.design({defaultResponder:"MySystem.statechart",childViews:"topView".w(),canvasView:SC.outlet("topView.bottomRightView.bottomRightView"),diagramView:SC.outlet("canvasView.diagramView"),topView:SC.SplitView.design({defaultThickness:120,topLeftView:SC.ScrollView.design({contentView:MySystem.NodePaletteView.design({layout:{top:0,left:0}})}),dividerView:SC.SplitDividerView,bottomRightView:SC.SplitView.design({defaultThickness:60,layoutDirection:SC.LAYOUT_VERTICAL,topLeftView:MySystem.InstructionView,dividerView:SC.SplitDividerView,bottomRightView:RaphaelViews.RaphaelCanvasView.design({layout:{top:120,left:0,right:0,bottom:0},classNames:"diagram-background",childViews:"diagramBackground diagramView".w(),diagramBackground:MySystem.DiagramBackgroundView.design({imageUrlBinding:"MySystem.activityController.backgroundImage",scalingEnabledBinding:SC.Binding.oneWay("MySystem.activityController.backgroundImageScaling")}),diagramView:MySystem.DiagramView.design({contentBinding:SC.Binding.from("MySystem.nodesController"),selectionBinding:"MySystem.nodesController.selection",canvasView:SC.outlet("parentView")}),mouseDown:function(a){return this.get("diagramView").mouseDown(a)}})})})}),inspectorPane:MySystem.InspectorPane,sentenceLinkPane:MySystem.SentenceConnectPane});sc_require("lib/old_format_json_parser");MySystem.studentMode=MySystem.ADVANCED_STUDENT;MySystem.setupStore=function(b,a){delete MySystem.Node._nextIdIndex;delete MySystem.Link._nextIdIndex;if(typeof a==="undefined"){a=NO}b.dataSource=SC.CascadeDataSource.create({dataSources:["studentStateDataSource","fixturesDataSource"],studentStateDataSource:MySystem.MergedHashDataSource.create({ignoreUndeclaredFields:a,handledRecordTypes:[MySystem.Link,MySystem.Node,MySystem.Story,MySystem.StorySentence,MySystem.RuleFeedback,MySystem.GraphicPreview,MySystem.RubricScore],dataStoreDidUpdateDataHash:function(){this.get("dataHash").version=MySystem.learnerDataVersion;var c=JSON.stringify(this.get("dataHash"),null,2);SC.$("#my_system_state").text(c);MySystem.savingController.set("dataIsDirty",YES)}}),fixturesDataSource:SC.FixturesDataSource.create({commitRecords:function(){return YES}})});b.store=SC.Store.create({commitRecordsAutomatically:YES,setStudentStateDataHash:function(c){this.dataSource.studentStateDataSource.setDataHash(this,c)},getStudentStateDataHash:function(){var c=this.dataSource.studentStateDataSource.dataHash();return JSON.stringify(c,null,2)}}).from(b.dataSource)};MySystem.main=function main(){MySystem.setupStore(MySystem);MySystem.updateFromDOM();MySystem.getPath("mainPage.mainPane").append();SC.ExceptionHandler=MySystem.ExceptionHandler;var b=MySystem.store.find(MySystem.Diagrammable);MySystem.nodesController.set("content",b);var d=MySystem.store.find(MySystem.Activity,"assign1");MySystem.activityController.set("content",d);var a=SC.Query.local(MySystem.StorySentence,{orderBy:"order"});var c=MySystem.store.find(a);MySystem.storySentenceController.set("content",c);MySystem.canvasView=MySystem.mainPage.mainPane.get("diagramView");MySystem.statechart.initStatechart();MySystem.storyController.showInstructions();SC.RootResponder.CAPTURE_BACKSPACE_KEY=YES};function main(){MySystem.main()}MySystem.clearCanvas=function(){var b;var a=MySystem.store.find(MySystem.Node);for(b=0;b<a.get("length");++b){a.objectAt(b).destroy()}};MySystem.loadCanvas=function(){MySystem.clearCanvas();var b=MySystem.store.find(MySystem.StudentState).objectAt(0);var a=JSON.parse(b.get("content"));MySystem.parseOldFormatJson(a)};MySystem.loadWiseConfig=function(b,a){SC.run(function(){var d=MySystem.Activity.fromWiseStepDef(b);MySystem.activityController.set("content",d);MySystem.updateFromDOM();var c=MySystem.store.find(MySystem.RuleFeedback,MySystem.RuleFeedback.LAST_FEEDBACK_GUID);MySystem.activityController.set("lastFeedback",c.get("feedback"));MySystem.activityController.set("numOfSubmits",c.get("numOfSubmits"))})};MySystem.registerExternalSaveFunction=function(b,a){if(!!b){MySystem.savingController.set("saveFunction",function(c){b.call(a,c)})}else{MySystem.savingController.set("saveFunction",null)}};MySystem.preExternalSave=function(){SC.RunLoop.begin();MySystem.activityController.getDiagramFeedback({isSubmit:NO});MySystem.GraphicPreview.makePreview(MySystem.store);SC.RunLoop.end()};MySystem.setAutoSaveFrequency=function(a){MySystem.savingController.set("autoSaveFrequency",a)};MySystem.externalSaveSuccessful=function(a){MySystem.savingController.saveSuccessful(a)};